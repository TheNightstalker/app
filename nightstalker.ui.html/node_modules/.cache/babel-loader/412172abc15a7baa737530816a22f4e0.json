{"ast":null,"code":"function _typeof(obj) { \"@babel/helpers - typeof\"; if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; }; } return _typeof(obj); }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }\n\nfunction _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }\n\nfunction _get(target, property, receiver) { if (typeof Reflect !== \"undefined\" && Reflect.get) { _get = Reflect.get; } else { _get = function _get(target, property, receiver) { var base = _superPropBase(target, property); if (!base) return; var desc = Object.getOwnPropertyDescriptor(base, property); if (desc.get) { return desc.get.call(receiver); } return desc.value; }; } return _get(target, property, receiver || target); }\n\nfunction _superPropBase(object, property) { while (!Object.prototype.hasOwnProperty.call(object, property)) { object = _getPrototypeOf(object); if (object === null) break; } return object; }\n\nfunction _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function\"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); }\n\nfunction _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }\n\nfunction _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === \"object\" || typeof call === \"function\")) { return call; } return _assertThisInitialized(self); }\n\nfunction _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return self; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }\n\nfunction _getPrototypeOf(o) { _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) { return o.__proto__ || Object.getPrototypeOf(o); }; return _getPrototypeOf(o); }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\n/*\n * Copyright (c) 2014-2017 BSI Business Systems Integration AG.\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the Eclipse Public License v1.0\n * which accompanies this distribution, and is available at\n * http://www.eclipse.org/legal/epl-v10.html\n *\n * Contributors:\n *     BSI Business Systems Integration AG - initial API and implementation\n */\nimport { arrays, HtmlComponent, LookupCall, objects, Status, strings, ValueField } from '../../index';\nimport $ from 'jquery';\n\nvar LookupBox = /*#__PURE__*/function (_ValueField) {\n  _inherits(LookupBox, _ValueField);\n\n  var _super = _createSuper(LookupBox);\n\n  function LookupBox() {\n    var _this;\n\n    _classCallCheck(this, LookupBox);\n\n    _this = _super.call(this);\n    _this.filterBox = null;\n    _this.gridDataHints.weightY = 1.0;\n    _this.gridDataHints.h = 2;\n    _this.value = [];\n    _this.lookupCall = null;\n    _this._pendingLookup = null;\n    _this._currentLookupCall = null;\n    _this._pendingLookup = null;\n    _this._lookupExecuted = false;\n    _this._valueSyncing = false; // true when value is either syncing to table or table to value\n\n    _this._addCloneProperties(['lookupCall']);\n\n    return _this;\n  }\n\n  _createClass(LookupBox, [{\n    key: \"_init\",\n    value: function _init(model) {\n      _get(_getPrototypeOf(LookupBox.prototype), \"_init\", this).call(this, model);\n\n      if (this.filterBox) {\n        this.filterBox.enabledComputed = true; // filter is always enabled\n\n        this.filterBox.recomputeEnabled(true);\n        this.filterBox.on('propertyChange', this._onFilterBoxPropertyChange.bind(this));\n      }\n    }\n  }, {\n    key: \"_initValue\",\n    value: function _initValue(value) {\n      if (this.lookupCall) {\n        this._setLookupCall(this.lookupCall);\n      }\n\n      this._initStructure(value);\n\n      _get(_getPrototypeOf(LookupBox.prototype), \"_initValue\", this).call(this, value);\n    }\n  }, {\n    key: \"_render\",\n    value: function _render() {\n      this.addContainer(this.$parent, 'lookup-box');\n      this.addLabel();\n      this.addMandatoryIndicator();\n      this.addStatus();\n      this.addFieldContainer(this.$parent.makeDiv());\n      var htmlComp = HtmlComponent.install(this.$fieldContainer, this.session);\n      htmlComp.setLayout(this._createFieldContainerLayout());\n\n      this._ensureLookupCallExecuted();\n\n      this._renderStructure();\n\n      this.$field.addDeviceClass();\n      this.$field.addClass('structure');\n\n      this._renderFilterBox();\n    }\n  }, {\n    key: \"_renderFilterBox\",\n    value: function _renderFilterBox() {\n      if (!this.filterBox || !this.filterBox.visible) {\n        return;\n      }\n\n      this.filterBox.render(this.$fieldContainer);\n    }\n  }, {\n    key: \"_ensureValue\",\n    value: function _ensureValue(value) {\n      return arrays.ensure(value);\n    }\n  }, {\n    key: \"_updateEmpty\",\n    value: function _updateEmpty() {\n      this.empty = arrays.empty(this.value);\n    }\n  }, {\n    key: \"_lookupByAll\",\n    value: function _lookupByAll() {\n      if (!this.lookupCall) {\n        return;\n      }\n\n      this._clearPendingLookup();\n\n      var deferred = $.Deferred();\n\n      var doneHandler = function (result) {\n        this._lookupByAllDone(result);\n\n        deferred.resolve(result);\n      }.bind(this);\n\n      this._executeLookup(this.lookupCall.cloneForAll(), true).done(doneHandler);\n\n      return deferred.promise();\n    }\n  }, {\n    key: \"_clearPendingLookup\",\n    value: function _clearPendingLookup() {\n      if (this._pendingLookup) {\n        clearTimeout(this._pendingLookup);\n        this._pendingLookup = null;\n      }\n    }\n  }, {\n    key: \"_executeLookup\",\n    value: function _executeLookup(lookupCall, abortExisting) {\n      this.setLoading(true);\n\n      if (abortExisting && this._currentLookupCall) {\n        this._currentLookupCall.abort();\n      }\n\n      this._currentLookupCall = lookupCall;\n      this.trigger('prepareLookupCall', {\n        lookupCall: lookupCall\n      });\n      return lookupCall.execute().always(function () {\n        this._currentLookupCall = null;\n        this._lookupExecuted = true;\n        this.setLoading(false);\n\n        this._clearLookupStatus();\n      }.bind(this));\n    }\n  }, {\n    key: \"_lookupByAllDone\",\n    value: function _lookupByAllDone(result) {\n      try {\n        if (result.exception) {\n          // Oops! Something went wrong while the lookup has been processed.\n          this.setErrorStatus(Status.error({\n            message: result.exception\n          }));\n          return false;\n        } // 'No data' case\n\n\n        if (result.lookupRows.length === 0) {\n          this.setLookupStatus(Status.warning({\n            message: this.session.text('SmartFieldNoDataFound'),\n            code: LookupBox.ErrorCode.NO_DATA\n          }));\n          return false;\n        }\n\n        return true;\n      } finally {\n        this.trigger('lookupCallDone', {\n          result: result\n        });\n      }\n    }\n  }, {\n    key: \"_errorStatus\",\n    value: function _errorStatus() {\n      return this.lookupStatus || this.errorStatus;\n    }\n  }, {\n    key: \"setLookupStatus\",\n    value: function setLookupStatus(lookupStatus) {\n      this.setProperty('lookupStatus', lookupStatus);\n\n      if (this.rendered) {\n        this._renderErrorStatus();\n      }\n    }\n  }, {\n    key: \"clearErrorStatus\",\n    value: function clearErrorStatus() {\n      this.setErrorStatus(null);\n\n      this._clearLookupStatus();\n    }\n  }, {\n    key: \"_clearLookupStatus\",\n    value: function _clearLookupStatus() {\n      this.setLookupStatus(null);\n    }\n  }, {\n    key: \"setLookupCall\",\n    value: function setLookupCall(lookupCall) {\n      this.setProperty('lookupCall', lookupCall);\n    }\n  }, {\n    key: \"_setLookupCall\",\n    value: function _setLookupCall(lookupCall) {\n      this._setProperty('lookupCall', LookupCall.ensure(lookupCall, this.session));\n\n      this._lookupExecuted = false;\n\n      if (this.rendered) {\n        this._ensureLookupCallExecuted();\n      }\n    }\n  }, {\n    key: \"refreshLookup\",\n    value: function refreshLookup() {\n      this._lookupExecuted = false;\n\n      this._ensureLookupCallExecuted();\n    }\n    /**\n     * @return {boolean} true if a lookup call execution has been scheduled now. false otherwise.\n     */\n\n  }, {\n    key: \"_ensureLookupCallExecuted\",\n    value: function _ensureLookupCallExecuted() {\n      if (this._lookupExecuted) {\n        return false;\n      }\n\n      this._lookupByAll();\n\n      return true;\n    }\n  }, {\n    key: \"_formatValue\",\n    value: function _formatValue(value) {\n      if (objects.isNullOrUndefined(value)) {\n        return '';\n      }\n\n      return this._formatLookupRows(this.getCheckedLookupRows());\n    }\n  }, {\n    key: \"_formatLookupRows\",\n    value: function _formatLookupRows(lookupRows) {\n      lookupRows = arrays.ensure(lookupRows);\n\n      if (lookupRows.length === 0) {\n        return '';\n      }\n\n      var formatted = [];\n      lookupRows.forEach(function (row) {\n        formatted.push(row.text);\n      });\n      return strings.join(', ', formatted);\n    }\n  }, {\n    key: \"_readDisplayText\",\n    value: function _readDisplayText() {\n      return this.displayText;\n    }\n  }, {\n    key: \"_clear\",\n    value: function _clear() {\n      this.setValue(null);\n    }\n  }, {\n    key: \"_onFilterBoxPropertyChange\",\n    value: function _onFilterBoxPropertyChange(event) {\n      if (event.propertyName === 'visible') {\n        if (!this.rendered) {\n          return;\n        }\n\n        if (this.filterBox.visible) {\n          this._renderFilterBox();\n        } else {\n          this.filterBox.remove();\n        }\n      }\n    }\n  }]);\n\n  return LookupBox;\n}(ValueField);\n\n_defineProperty(LookupBox, \"ErrorCode\", {\n  NO_DATA: 1\n});\n\nexport { LookupBox as default };","map":{"version":3,"sources":["C:/Tools/workspace/nightstalker/nightstalker.ui.html/node_modules/@eclipse-scout/core/src/form/fields/LookupBox.js"],"names":["arrays","HtmlComponent","LookupCall","objects","Status","strings","ValueField","$","LookupBox","filterBox","gridDataHints","weightY","h","value","lookupCall","_pendingLookup","_currentLookupCall","_lookupExecuted","_valueSyncing","_addCloneProperties","model","enabledComputed","recomputeEnabled","on","_onFilterBoxPropertyChange","bind","_setLookupCall","_initStructure","addContainer","$parent","addLabel","addMandatoryIndicator","addStatus","addFieldContainer","makeDiv","htmlComp","install","$fieldContainer","session","setLayout","_createFieldContainerLayout","_ensureLookupCallExecuted","_renderStructure","$field","addDeviceClass","addClass","_renderFilterBox","visible","render","ensure","empty","_clearPendingLookup","deferred","Deferred","doneHandler","result","_lookupByAllDone","resolve","_executeLookup","cloneForAll","done","promise","clearTimeout","abortExisting","setLoading","abort","trigger","execute","always","_clearLookupStatus","exception","setErrorStatus","error","message","lookupRows","length","setLookupStatus","warning","text","code","ErrorCode","NO_DATA","lookupStatus","errorStatus","setProperty","rendered","_renderErrorStatus","_setProperty","_lookupByAll","isNullOrUndefined","_formatLookupRows","getCheckedLookupRows","formatted","forEach","row","push","join","displayText","setValue","event","propertyName","remove"],"mappings":"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","sourcesContent":["/*\n * Copyright (c) 2014-2017 BSI Business Systems Integration AG.\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the Eclipse Public License v1.0\n * which accompanies this distribution, and is available at\n * http://www.eclipse.org/legal/epl-v10.html\n *\n * Contributors:\n *     BSI Business Systems Integration AG - initial API and implementation\n */\nimport {arrays, HtmlComponent, LookupCall, objects, Status, strings, ValueField} from '../../index';\nimport $ from 'jquery';\n\nexport default class LookupBox extends ValueField {\n\n  constructor() {\n    super();\n    this.filterBox = null;\n    this.gridDataHints.weightY = 1.0;\n    this.gridDataHints.h = 2;\n    this.value = [];\n\n    this.lookupCall = null;\n    this._pendingLookup = null;\n    this._currentLookupCall = null;\n    this._pendingLookup = null;\n    this._lookupExecuted = false;\n    this._valueSyncing = false; // true when value is either syncing to table or table to value\n\n    this._addCloneProperties(['lookupCall']);\n  }\n\n  static ErrorCode = {\n    NO_DATA: 1\n  };\n\n  _init(model) {\n    super._init(model);\n    if (this.filterBox) {\n      this.filterBox.enabledComputed = true; // filter is always enabled\n      this.filterBox.recomputeEnabled(true);\n      this.filterBox.on('propertyChange', this._onFilterBoxPropertyChange.bind(this));\n    }\n  }\n\n  _initValue(value) {\n    if (this.lookupCall) {\n      this._setLookupCall(this.lookupCall);\n    }\n    this._initStructure(value);\n    super._initValue(value);\n  }\n\n  _render() {\n    this.addContainer(this.$parent, 'lookup-box');\n    this.addLabel();\n    this.addMandatoryIndicator();\n    this.addStatus();\n    this.addFieldContainer(this.$parent.makeDiv());\n\n    var htmlComp = HtmlComponent.install(this.$fieldContainer, this.session);\n    htmlComp.setLayout(this._createFieldContainerLayout());\n\n    this._ensureLookupCallExecuted();\n    this._renderStructure();\n    this.$field.addDeviceClass();\n    this.$field.addClass('structure');\n    this._renderFilterBox();\n  }\n\n  _renderFilterBox() {\n    if (!this.filterBox || !this.filterBox.visible) {\n      return;\n    }\n    this.filterBox.render(this.$fieldContainer);\n  }\n\n  _ensureValue(value) {\n    return arrays.ensure(value);\n  }\n\n  _updateEmpty() {\n    this.empty = arrays.empty(this.value);\n  }\n\n  _lookupByAll() {\n    if (!this.lookupCall) {\n      return;\n    }\n    this._clearPendingLookup();\n\n    var deferred = $.Deferred();\n    var doneHandler = function(result) {\n      this._lookupByAllDone(result);\n      deferred.resolve(result);\n    }.bind(this);\n\n    this._executeLookup(this.lookupCall.cloneForAll(), true)\n      .done(doneHandler);\n\n    return deferred.promise();\n  }\n\n  _clearPendingLookup() {\n    if (this._pendingLookup) {\n      clearTimeout(this._pendingLookup);\n      this._pendingLookup = null;\n    }\n  }\n\n  _executeLookup(lookupCall, abortExisting) {\n    this.setLoading(true);\n\n    if (abortExisting && this._currentLookupCall) {\n      this._currentLookupCall.abort();\n    }\n    this._currentLookupCall = lookupCall;\n    this.trigger('prepareLookupCall', {\n      lookupCall: lookupCall\n    });\n\n    return lookupCall\n      .execute()\n      .always(function() {\n        this._currentLookupCall = null;\n        this._lookupExecuted = true;\n        this.setLoading(false);\n        this._clearLookupStatus();\n      }.bind(this));\n  }\n\n  _lookupByAllDone(result) {\n    try {\n      if (result.exception) {\n        // Oops! Something went wrong while the lookup has been processed.\n        this.setErrorStatus(Status.error({\n          message: result.exception\n        }));\n        return false;\n      }\n\n      // 'No data' case\n      if (result.lookupRows.length === 0) {\n        this.setLookupStatus(Status.warning({\n          message: this.session.text('SmartFieldNoDataFound'),\n          code: LookupBox.ErrorCode.NO_DATA\n        }));\n        return false;\n      }\n\n      return true;\n    } finally {\n      this.trigger('lookupCallDone', {\n        result: result\n      });\n    }\n  }\n\n  _errorStatus() {\n    return this.lookupStatus || this.errorStatus;\n  }\n\n  setLookupStatus(lookupStatus) {\n    this.setProperty('lookupStatus', lookupStatus);\n    if (this.rendered) {\n      this._renderErrorStatus();\n    }\n  }\n\n  clearErrorStatus() {\n    this.setErrorStatus(null);\n    this._clearLookupStatus();\n  }\n\n  _clearLookupStatus() {\n    this.setLookupStatus(null);\n  }\n\n  setLookupCall(lookupCall) {\n    this.setProperty('lookupCall', lookupCall);\n  }\n\n  _setLookupCall(lookupCall) {\n    this._setProperty('lookupCall', LookupCall.ensure(lookupCall, this.session));\n    this._lookupExecuted = false;\n    if (this.rendered) {\n      this._ensureLookupCallExecuted();\n    }\n  }\n\n  refreshLookup() {\n    this._lookupExecuted = false;\n    this._ensureLookupCallExecuted();\n  }\n\n  /**\n   * @return {boolean} true if a lookup call execution has been scheduled now. false otherwise.\n   */\n  _ensureLookupCallExecuted() {\n    if (this._lookupExecuted) {\n      return false;\n    }\n    this._lookupByAll();\n    return true;\n  }\n\n  _formatValue(value) {\n    if (objects.isNullOrUndefined(value)) {\n      return '';\n    }\n\n    return this._formatLookupRows(this.getCheckedLookupRows());\n  }\n\n  _formatLookupRows(lookupRows) {\n    lookupRows = arrays.ensure(lookupRows);\n    if (lookupRows.length === 0) {\n      return '';\n    }\n\n    var formatted = [];\n    lookupRows.forEach(function(row) {\n      formatted.push(row.text);\n    });\n    return strings.join(', ', formatted);\n  }\n\n  _readDisplayText() {\n    return this.displayText;\n  }\n\n  _clear() {\n    this.setValue(null);\n  }\n\n  _onFilterBoxPropertyChange(event) {\n    if (event.propertyName === 'visible') {\n      if (!this.rendered) {\n        return;\n      }\n      if (this.filterBox.visible) {\n        this._renderFilterBox();\n      } else {\n        this.filterBox.remove();\n      }\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"module"}