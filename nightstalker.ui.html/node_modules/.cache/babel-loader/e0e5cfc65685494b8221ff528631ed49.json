{"ast":null,"code":"function _typeof(obj) { \"@babel/helpers - typeof\"; if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; }; } return _typeof(obj); }\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }\n\nfunction _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }\n\nfunction _get(target, property, receiver) { if (typeof Reflect !== \"undefined\" && Reflect.get) { _get = Reflect.get; } else { _get = function _get(target, property, receiver) { var base = _superPropBase(target, property); if (!base) return; var desc = Object.getOwnPropertyDescriptor(base, property); if (desc.get) { return desc.get.call(receiver); } return desc.value; }; } return _get(target, property, receiver || target); }\n\nfunction _superPropBase(object, property) { while (!Object.prototype.hasOwnProperty.call(object, property)) { object = _getPrototypeOf(object); if (object === null) break; } return object; }\n\nfunction _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function\"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); }\n\nfunction _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }\n\nfunction _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === \"object\" || typeof call === \"function\")) { return call; } return _assertThisInitialized(self); }\n\nfunction _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return self; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }\n\nfunction _getPrototypeOf(o) { _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) { return o.__proto__ || Object.getPrototypeOf(o); }; return _getPrototypeOf(o); }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\n/*\n * Copyright (c) 2014-2018 BSI Business Systems Integration AG.\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the Eclipse Public License v1.0\n * which accompanies this distribution, and is available at\n * http://www.eclipse.org/legal/epl-v10.html\n *\n * Contributors:\n *     BSI Business Systems Integration AG - initial API and implementation\n */\nimport { arrays, DateFormat, DateRange, dates, defaultValues, graphics, HtmlComponent, KeyStrokeContext, MenuBar, menus as menus_1, objects, PlannerLayout, PlannerMenuItemsOrder, Range, scout, scrollbars, strings, styles, tooltips, TooltipSupport, Widget } from '../index';\nimport $ from 'jquery';\n\nvar Planner = /*#__PURE__*/function (_Widget) {\n  _inherits(Planner, _Widget);\n\n  var _super = _createSuper(Planner);\n\n  function Planner() {\n    var _this;\n\n    _classCallCheck(this, Planner);\n\n    _this = _super.call(this);\n    _this.activityMap = [];\n    _this.activitySelectable = false;\n    _this.availableDisplayModes = [];\n    _this.displayMode = null;\n    _this.displayModeOptions = {};\n    _this.headerVisible = true;\n    _this.label = null;\n    _this.resources = [];\n    _this.resourceMap = [];\n    _this.selectionMode = Planner.SelectionMode.MULTI_RANGE;\n    _this.selectionRange = new DateRange();\n    _this.selectedResources = [];\n    _this.viewRange = {};\n    _this.selectedActivity = null; // visual\n\n    _this._resourceTitleWidth = 20;\n    _this._rangeSelectionStarted = false;\n    _this.startRow = null;\n    _this.lastRow = null; // main elements\n\n    _this.$container = null;\n    _this.$range = null;\n    _this.$modes = null;\n    _this.$grid = null; // scale calculator\n\n    _this.transformLeft = function (t) {\n      return t;\n    };\n\n    _this.transformWidth = function (t0, t1) {\n      return t1 - t0;\n    };\n\n    _this.yearPanelVisible = false;\n\n    _this._addWidgetProperties(['menus']);\n\n    return _this;\n  }\n\n  _createClass(Planner, [{\n    key: \"_createKeyStrokeContext\",\n\n    /**\n     * @override\n     */\n    value: function _createKeyStrokeContext() {\n      return new KeyStrokeContext();\n    }\n  }, {\n    key: \"_init\",\n    value: function _init(model) {\n      _get(_getPrototypeOf(Planner.prototype), \"_init\", this).call(this, model);\n\n      this._yearPanel = scout.create('YearPanel', {\n        parent: this,\n        alwaysSelectFirstDay: true\n      });\n\n      this._yearPanel.on('dateSelect', this._onYearPanelDateSelect.bind(this));\n\n      this._header = scout.create('PlannerHeader', {\n        parent: this\n      });\n\n      this._header.on('todayClick', this._onTodayClick.bind(this));\n\n      this._header.on('yearClick', this._onYearClick.bind(this));\n\n      this._header.on('previousClick', this._onPreviousClick.bind(this));\n\n      this._header.on('nextClick', this._onNextClick.bind(this));\n\n      this._header.on('displayModeClick', this._onDisplayModeClick.bind(this));\n\n      this.menuBar = scout.create('MenuBar', {\n        parent: this,\n        position: MenuBar.Position.BOTTOM,\n        menuOrder: new PlannerMenuItemsOrder(this.session, 'Planner')\n      });\n\n      for (var i = 0; i < this.resources.length; i++) {\n        this._initResource(this.resources[i]);\n      }\n\n      this._setDisplayMode(this.displayMode);\n\n      this._setAvailableDisplayModes(this.availableDisplayModes);\n\n      this._setViewRange(this.viewRange);\n\n      this._setSelectedResources(this.selectedResources);\n\n      this._setSelectedActivity(this.selectedActivity);\n\n      this._setSelectionRange(this.selectionRange);\n\n      this._setMenus(this.menus);\n\n      this._setDisplayModeOptions(this.displayModeOptions);\n\n      this._tooltipSupport = new TooltipSupport({\n        parent: this,\n        arrowPosition: 50\n      });\n    }\n  }, {\n    key: \"_initResource\",\n    value: function _initResource(resource) {\n      defaultValues.applyTo(resource, 'Resource');\n      resource.activities.forEach(function (activity) {\n        this._initActivity(activity);\n      }, this);\n      this.resourceMap[resource.id] = resource;\n    }\n  }, {\n    key: \"_initActivity\",\n    value: function _initActivity(activity) {\n      activity.beginTime = dates.parseJsonDate(activity.beginTime);\n      activity.endTime = dates.parseJsonDate(activity.endTime);\n      defaultValues.applyTo(activity, 'Activity');\n      this.activityMap[activity.id] = activity;\n    }\n  }, {\n    key: \"_render\",\n    value: function _render() {\n      // basics, layout etc.\n      this.$container = this.$parent.appendDiv('planner');\n      var layout = new PlannerLayout(this);\n      this.htmlComp = HtmlComponent.install(this.$container, this.session);\n      this.htmlComp.setLayout(layout); // main elements\n\n      this._header.render();\n\n      this._yearPanel.render();\n\n      this.$grid = this.$container.appendDiv('planner-grid').on('mousedown', '.resource-cells', this._onCellMouseDown.bind(this)).on('mousedown', '.resource-title', this._onResourceTitleMouseDown.bind(this)).on('contextmenu', '.resource-title', this._onResourceTitleContextMenu.bind(this)).on('contextmenu', '.planner-activity', this._onActivityContextMenu.bind(this));\n      this.$scale = this.$container.appendDiv('planner-scale');\n      this.menuBar.render();\n      tooltips.install(this.$grid, {\n        parent: this,\n        selector: '.planner-activity',\n        text: function ($comp) {\n          if (this._activityById($comp.attr('data-id'))) {\n            return this._activityById($comp.attr('data-id')).tooltipText;\n          }\n\n          return undefined;\n        }.bind(this)\n      });\n\n      this._installScrollbars();\n\n      this._gridScrollHandler = this._onGridScroll.bind(this);\n      this.$grid.on('scroll', this._gridScrollHandler);\n    }\n  }, {\n    key: \"_renderProperties\",\n    value: function _renderProperties() {\n      _get(_getPrototypeOf(Planner.prototype), \"_renderProperties\", this).call(this);\n\n      this._renderViewRange();\n\n      this._renderHeaderVisible();\n\n      this._renderYearPanelVisible(false);\n\n      this._renderResources();\n\n      this._renderSelectedActivity();\n\n      this._renderSelectedResources(); // render with setTimeout because the planner needs to be layouted first\n\n\n      setTimeout(this._renderSelectionRange.bind(this));\n    }\n    /**\n     * @override\n     */\n\n  }, {\n    key: \"get$Scrollable\",\n    value: function get$Scrollable() {\n      return this.$grid;\n    }\n    /* -- basics, events -------------------------------------------- */\n\n  }, {\n    key: \"_onPreviousClick\",\n    value: function _onPreviousClick(event) {\n      this._navigateDate(Planner.Direction.BACKWARD);\n    }\n  }, {\n    key: \"_onNextClick\",\n    value: function _onNextClick(event) {\n      this._navigateDate(Planner.Direction.FORWARD);\n    }\n  }, {\n    key: \"_navigateDate\",\n    value: function _navigateDate(direction) {\n      var viewRange = new DateRange(this.viewRange.from, this.viewRange.to),\n          displayMode = Planner.DisplayMode;\n\n      if (this.displayMode === displayMode.DAY) {\n        viewRange.from = dates.shift(this.viewRange.from, 0, 0, direction);\n        viewRange.to = dates.shift(this.viewRange.to, 0, 0, direction);\n      } else if (scout.isOneOf(this.displayMode, displayMode.WEEK, displayMode.WORK_WEEK)) {\n        viewRange.from = dates.shift(this.viewRange.from, 0, 0, direction * 7);\n        viewRange.from = dates.ensureMonday(viewRange.from, -1 * direction);\n        viewRange.to = dates.shift(this.viewRange.to, 0, 0, direction * 7);\n      } else if (this.displayMode === displayMode.MONTH) {\n        viewRange.from = dates.shift(this.viewRange.from, 0, direction, 0);\n        viewRange.from = dates.ensureMonday(viewRange.from, -1 * direction);\n        viewRange.to = dates.shift(this.viewRange.to, 0, direction, 0);\n      } else if (this.displayMode === displayMode.CALENDAR_WEEK) {\n        viewRange.from = dates.shift(this.viewRange.from, 0, direction, 0);\n        viewRange.from = dates.ensureMonday(viewRange.from, -1 * direction);\n        viewRange.to = dates.shift(this.viewRange.to, 0, direction, 0);\n      } else if (this.displayMode === displayMode.YEAR) {\n        viewRange.from = dates.shift(this.viewRange.from, 0, 3 * direction, 0);\n        viewRange.to = dates.shift(this.viewRange.to, 0, 3 * direction, 0);\n      }\n\n      this.setViewRange(viewRange);\n    }\n  }, {\n    key: \"_onTodayClick\",\n    value: function _onTodayClick(event) {\n      var today = new Date(),\n          year = today.getFullYear(),\n          month = today.getMonth(),\n          date = today.getDate(),\n          day = (today.getDay() + 6) % 7,\n          displayMode = Planner.DisplayMode;\n\n      if (this.displayMode === displayMode.DAY) {\n        today = new Date(year, month, date);\n      } else if (this.displayMode === displayMode.YEAR) {\n        today = new Date(year, month, 1);\n      } else {\n        today = new Date(year, month, date - day);\n      }\n\n      this.setViewRangeFrom(today);\n    }\n  }, {\n    key: \"_onDisplayModeClick\",\n    value: function _onDisplayModeClick(event) {\n      var displayMode = event.displayMode;\n      this.setDisplayMode(displayMode);\n    }\n  }, {\n    key: \"_onYearClick\",\n    value: function _onYearClick(event) {\n      this.setYearPanelVisible(!this.yearPanelVisible);\n    }\n  }, {\n    key: \"_onYearPanelDateSelect\",\n    value: function _onYearPanelDateSelect(event) {\n      this.setViewRangeFrom(event.date);\n    }\n  }, {\n    key: \"_onResourceTitleMouseDown\",\n    value: function _onResourceTitleMouseDown(event) {\n      var $resource = $(event.target).parent();\n\n      if ($resource.isSelected()) {\n        if (event.which === 3 || event.which === 1 && event.ctrlKey) {\n          // Right click on an already selected resource must not clear the selection -> context menu will be opened\n          return;\n        }\n      }\n\n      this.startRow = $resource.data('resource');\n      this.lastRow = this.startRow;\n\n      this._select();\n    }\n  }, {\n    key: \"_onResourceTitleContextMenu\",\n    value: function _onResourceTitleContextMenu(event) {\n      this._showContextMenu(event, 'Planner.Resource');\n    }\n  }, {\n    key: \"_onRangeSelectorContextMenu\",\n    value: function _onRangeSelectorContextMenu(event) {\n      this._showContextMenu(event, 'Planner.Range');\n    }\n  }, {\n    key: \"_onActivityContextMenu\",\n    value: function _onActivityContextMenu(event) {\n      this._showContextMenu(event, 'Planner.Activity');\n    }\n  }, {\n    key: \"_showContextMenu\",\n    value: function _showContextMenu(event, allowedType) {\n      event.preventDefault();\n      event.stopPropagation();\n\n      var func = function func(event, allowedType) {\n        if (!this.rendered || !this.attached) {\n          // check needed because function is called asynchronously\n          return;\n        }\n\n        var filteredMenus = this._filterMenus([allowedType], true),\n            $part = $(event.currentTarget);\n\n        if (filteredMenus.length === 0) {\n          return; // at least one menu item must be visible\n        }\n\n        var popup = scout.create('ContextMenuPopup', {\n          parent: this,\n          menuItems: filteredMenus,\n          location: {\n            x: event.pageX,\n            y: event.pageY\n          },\n          $anchor: $part\n        });\n        popup.open();\n      }.bind(this);\n\n      this.session.onRequestsDone(func, event, allowedType);\n    }\n  }, {\n    key: \"_onGridScroll\",\n    value: function _onGridScroll() {\n      this._reconcileScrollPos();\n    }\n  }, {\n    key: \"_reconcileScrollPos\",\n    value: function _reconcileScrollPos() {\n      // When scrolling horizontally scroll scale as well\n      var scrollLeft = this.$grid.scrollLeft();\n      this.$scale.scrollLeft(scrollLeft);\n    }\n  }, {\n    key: \"_renderRange\",\n    value: function _renderRange() {\n      if (!this.viewRange.from || !this.viewRange.to) {\n        return;\n      }\n\n      var text,\n          toDate = new Date(this.viewRange.to.valueOf() - 1),\n          toText = this.session.text('ui.to'),\n          displayMode = Planner.DisplayMode; // find range text\n\n      if (dates.isSameDay(this.viewRange.from, toDate)) {\n        text = this._dateFormat(this.viewRange.from, 'd. MMMM yyyy');\n      } else if (this.viewRange.from.getMonth() === toDate.getMonth() && this.viewRange.from.getFullYear() === toDate.getFullYear()) {\n        text = strings.join(' ', this._dateFormat(this.viewRange.from, 'd.'), toText, this._dateFormat(toDate, 'd. MMMM yyyy'));\n      } else if (this.viewRange.from.getFullYear() === toDate.getFullYear()) {\n        if (this.displayMode === displayMode.YEAR) {\n          text = strings.join(' ', this._dateFormat(this.viewRange.from, 'MMMM'), toText, this._dateFormat(toDate, 'MMMM yyyy'));\n        } else {\n          text = strings.join(' ', this._dateFormat(this.viewRange.from, 'd.  MMMM'), toText, this._dateFormat(toDate, 'd. MMMM yyyy'));\n        }\n      } else {\n        if (this.displayMode === displayMode.YEAR) {\n          text = strings.join(' ', this._dateFormat(this.viewRange.from, 'MMMM yyyy'), toText, this._dateFormat(toDate, 'MMMM yyyy'));\n        } else {\n          text = strings.join(' ', this._dateFormat(this.viewRange.from, 'd.  MMMM yyyy'), toText, this._dateFormat(toDate, 'd. MMMM yyyy'));\n        }\n      } // set text\n\n\n      $('.planner-select', this._header.$range).text(text);\n    }\n  }, {\n    key: \"_renderScale\",\n    value: function _renderScale() {\n      if (!this.viewRange.from || !this.viewRange.to) {\n        return;\n      }\n\n      var width,\n          that = this,\n          displayMode = Planner.DisplayMode; // empty scale\n\n      this.$scale.empty();\n      this.$grid.children('.planner-small-scale-item-line').remove();\n      this.$grid.children('.planner-large-scale-item-line').remove(); // append main elements\n\n      this.$scaleTitle = this.$scale.appendDiv('planner-scale-title');\n\n      this._renderLabel();\n\n      this.$timeline = this.$scale.appendDiv('timeline');\n      this.$timelineLarge = this.$timeline.appendDiv('timeline-large');\n      this.$timelineSmall = this.$timeline.appendDiv('timeline-small'); // fill timeline large depending on mode\n\n      if (this.displayMode === displayMode.DAY) {\n        this._renderDayScale();\n      } else if (scout.isOneOf(this.displayMode, displayMode.WORK_WEEK, displayMode.WEEK)) {\n        this._renderWeekScale();\n      } else if (this.displayMode === displayMode.MONTH) {\n        this._renderMonthScale();\n      } else if (this.displayMode === displayMode.CALENDAR_WEEK) {\n        this._renderCalendarWeekScale();\n      } else if (this.displayMode === displayMode.YEAR) {\n        this._renderYearScale();\n      } // set sizes and append scale lines\n\n\n      var $smallScaleItems = this.$timelineSmall.children('.scale-item');\n      var $largeScaleItems = this.$timelineLarge.children('.scale-item');\n      width = 100 / $smallScaleItems.length;\n      $largeScaleItems.each(function () {\n        var $scaleItem = $(this);\n        var $largeGridLine = that.$grid.prependDiv('planner-large-scale-item-line');\n        $scaleItem.css('width', $scaleItem.data('count') * width + '%').data('scale-item-line', $largeGridLine);\n        $scaleItem.prependDiv('planner-large-scale-item-line').css('left', 0);\n      });\n      $smallScaleItems.each(function (index) {\n        var $scaleItem = $(this);\n        $scaleItem.css('width', width + '%');\n\n        if (!$scaleItem.data('first')) {\n          var $smallGridLine = that.$grid.prependDiv('planner-small-scale-item-line');\n          $scaleItem.data('scale-item-line', $smallGridLine);\n          $scaleItem.prependDiv('planner-small-scale-item-line').css('left', 0);\n        }\n      }); // find transfer function\n\n      this.beginScale = this.$timelineSmall.children().first().data('date-from').valueOf();\n      this.endScale = this.$timelineSmall.children().last().data('date-to').valueOf();\n\n      if (scout.isOneOf(this.displayMode, displayMode.WORK_WEEK, displayMode.WEEK)) {\n        var options = this.displayModeOptions[this.displayMode];\n        var interval = options.interval;\n        var firstHourOfDay = options.firstHourOfDay;\n        var lastHourOfDay = options.lastHourOfDay;\n\n        this.transformLeft = function (begin, end, firstHour, lastHour, interval) {\n          return function (t) {\n            t = new Date(t);\n            begin = new Date(begin);\n            end = new Date(end);\n            var fullRangeMillis = end - begin; // remove day component from range for scaling\n\n            var dayDiffTBegin = dates.compareDays(t, begin);\n            var dayDIffEndBegin = dates.compareDays(end, begin);\n            var dayComponentMillis = dayDiffTBegin * 3600000 * 24;\n            var rangeScaling = 24 / (lastHour - firstHour + 1); // re-add day component\n\n            var dayOffset = dayDiffTBegin / dayDIffEndBegin;\n\n            if (t.getHours() < firstHour) {\n              // If t is in the morning before the first hour of day, return 00:00 of this day\n              return (rangeScaling / fullRangeMillis + dayOffset) * 100;\n            }\n\n            if (t.getHours() > lastHour) {\n              // If t is in the evening after the last hour of day, return 00:00 of next day\n              dayOffset = (dayDiffTBegin + 1) / dayDIffEndBegin;\n              return (rangeScaling / fullRangeMillis + dayOffset) * 100;\n            }\n\n            return ((t.valueOf() - (begin.valueOf() + firstHour * 3600000) - dayComponentMillis) * rangeScaling / fullRangeMillis + dayOffset) * 100;\n          };\n        }(this.viewRange.from, this.viewRange.to, firstHourOfDay, lastHourOfDay, interval);\n\n        this.transformWidth = function (begin, end, firstHour, lastHour, interval) {\n          return function (t0, t1) {\n            var fullRangeMillis = end - begin;\n            var selectionRange = new Range(new Date(t0), new Date(t1));\n\n            var hiddenRanges = this._findHiddenRangesInWeekMode();\n\n            var selectedRangeMillis = selectionRange.subtractAll(hiddenRanges).reduce(function (acc, range) {\n              return acc + range.size();\n            }, 0);\n            var rangeScaling = 24 / (lastHour - firstHour + 1);\n            return selectedRangeMillis * rangeScaling / fullRangeMillis * 100;\n          };\n        }(this.viewRange.from, this.viewRange.to, firstHourOfDay, lastHourOfDay, interval);\n      } else {\n        this.transformLeft = function (begin, end) {\n          return function (t) {\n            return (t - begin) / (end - begin) * 100;\n          };\n        }(this.beginScale, this.endScale);\n\n        this.transformWidth = function (begin, end) {\n          return function (t0, t1) {\n            return (t1 - t0) / (end - begin) * 100;\n          };\n        }(this.beginScale, this.endScale);\n      }\n    }\n    /**\n     * Returns every hidden range of the view range created by first and last our of day.\n     */\n\n  }, {\n    key: \"_findHiddenRangesInWeekMode\",\n    value: function _findHiddenRangesInWeekMode() {\n      if (!scout.isOneOf(this.displayMode, Planner.DisplayMode.WORK_WEEK, Planner.DisplayMode.WEEK)) {\n        return [];\n      }\n\n      var ranges = [];\n      var options = this.displayModeOptions[this.displayMode];\n      var firstHourOfDay = options.firstHourOfDay;\n      var lastHourOfDay = options.lastHourOfDay;\n      var currentDate = new Date(this.viewRange.from.valueOf());\n      var hiddenRange;\n\n      while (currentDate < this.viewRange.to) {\n        // Start of day range\n        hiddenRange = new Range(new Date(currentDate.valueOf()), dates.shiftTime(currentDate, firstHourOfDay));\n\n        if (hiddenRange.size() > 0) {\n          ranges.push(hiddenRange);\n        } // End of day range\n\n\n        hiddenRange = new Range(dates.shiftTime(currentDate, lastHourOfDay + 1), dates.shiftTime(currentDate, 24));\n\n        if (hiddenRange.size() > 0) {\n          ranges.push(hiddenRange);\n        }\n\n        currentDate.setHours(0);\n        currentDate.setMinutes(0);\n        currentDate.setDate(currentDate.getDate() + 1);\n      }\n\n      return ranges;\n    }\n  }, {\n    key: \"_renderDayScale\",\n    value: function _renderDayScale() {\n      var newLargeGroup,\n          $divLarge,\n          $divSmall,\n          first = true;\n      var loop = new Date(this.viewRange.from.valueOf());\n      var options = this.displayModeOptions[this.displayMode];\n      var interval = options.interval;\n      var labelPeriod = options.labelPeriod;\n      var firstHourOfDay = options.firstHourOfDay;\n      var lastHourOfDay = options.lastHourOfDay; // cap interval to day range\n\n      interval = Math.min(interval, 60 * (lastHourOfDay - firstHourOfDay + 1)); // from start to end\n\n      while (loop < this.viewRange.to) {\n        if (loop.getHours() >= firstHourOfDay && loop.getHours() <= lastHourOfDay) {\n          newLargeGroup = false;\n\n          if (loop.getMinutes() === 0 || first) {\n            $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'HH')).data('count', 0);\n            newLargeGroup = true;\n          }\n\n          $divSmall = this.$timelineSmall.appendDiv('scale-item', this._dateFormat(loop, ':mm')).data('date-from', new Date(loop.valueOf())); // hide label\n\n          if (loop.getMinutes() % (interval * labelPeriod) !== 0) {\n            $divSmall.addClass('label-invisible');\n          } // increase variables\n\n\n          loop = dates.shiftTime(loop, 0, interval, 0);\n\n          this._incrementTimelineScaleItems($divLarge, $divSmall, loop, newLargeGroup);\n\n          first = false;\n        } else {\n          loop = dates.shiftTime(loop, 0, interval, 0);\n        }\n      }\n    }\n  }, {\n    key: \"_renderWeekScale\",\n    value: function _renderWeekScale() {\n      var newLargeGroup,\n          $divLarge,\n          $divSmall,\n          first = true;\n      var loop = new Date(this.viewRange.from.valueOf());\n      var options = this.displayModeOptions[this.displayMode];\n      var interval = options.interval;\n      var labelPeriod = options.labelPeriod;\n      var firstHourOfDay = options.firstHourOfDay;\n      var lastHourOfDay = options.lastHourOfDay; // cap interval to day range\n\n      interval = Math.min(interval, 60 * (lastHourOfDay - firstHourOfDay + 1)); // from start to end\n\n      while (loop < this.viewRange.to) {\n        newLargeGroup = false;\n\n        if (loop.getHours() < firstHourOfDay) {\n          loop.setHours(firstHourOfDay);\n        }\n\n        if (loop.getHours() === firstHourOfDay && loop.getMinutes() === 0 || first) {\n          if (loop.getMonth() === 0 || first) {\n            $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'd. MMMM yyyy')).data('count', 0);\n          } else if (loop.getDate() === 1) {\n            $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'd. MMMM')).data('count', 0);\n          } else {\n            $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'd.')).data('count', 0);\n          }\n\n          newLargeGroup = true;\n        }\n\n        $divSmall = this.$timelineSmall.appendDiv('scale-item', this._dateFormat(loop, 'HH:mm')).data('date-from', new Date(loop.valueOf())); // hide label\n\n        if (((loop.getHours() - firstHourOfDay) * 60 + loop.getMinutes()) % (interval * labelPeriod) !== 0) {\n          $divSmall.addClass('label-invisible');\n        } // increase variables\n\n\n        loop = dates.shiftTime(loop, 0, interval, 0, 0);\n\n        this._incrementTimelineScaleItems($divLarge, $divSmall, loop, newLargeGroup);\n\n        first = false;\n\n        if (loop.getHours() > lastHourOfDay) {\n          // jump to next day\n          loop.setHours(0);\n          loop.setMinutes(0);\n          loop.setDate(loop.getDate() + 1);\n        }\n      }\n    }\n  }, {\n    key: \"_renderMonthScale\",\n    value: function _renderMonthScale() {\n      var newLargeGroup,\n          $divLarge,\n          $divSmall,\n          first = true;\n      var loop = new Date(this.viewRange.from.valueOf());\n      var options = this.displayModeOptions[this.displayMode];\n      var labelPeriod = options.labelPeriod; // from start to end\n\n      while (loop < this.viewRange.to) {\n        newLargeGroup = false;\n\n        if (loop.getDate() === 1 || first) {\n          if (loop.getMonth() === 0 || first) {\n            $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'MMMM yyyy')).data('count', 0);\n          } else {\n            $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'MMMM')).data('count', 0);\n          }\n\n          newLargeGroup = true;\n        }\n\n        $divSmall = this.$timelineSmall.appendDiv('scale-item', this._dateFormat(loop, 'dd')).data('date-from', new Date(loop.valueOf())); // hide label\n\n        if (loop.getDate() % labelPeriod !== 0) {\n          $divSmall.addClass('label-invisible');\n        }\n\n        loop = dates.shift(loop, 0, 0, 1);\n\n        this._incrementTimelineScaleItems($divLarge, $divSmall, loop, newLargeGroup);\n\n        first = false;\n      }\n    }\n  }, {\n    key: \"_renderCalendarWeekScale\",\n    value: function _renderCalendarWeekScale() {\n      var newLargeGroup,\n          $divLarge,\n          $divSmall,\n          first = true;\n      var loop = new Date(this.viewRange.from.valueOf());\n      var options = this.displayModeOptions[this.displayMode];\n      var labelPeriod = options.labelPeriod; // from start to end\n\n      while (loop < this.viewRange.to) {\n        newLargeGroup = false;\n\n        if (loop.getDate() < 8 || first === true) {\n          if (loop.getMonth() === 0 || first === true) {\n            if (loop.getDate() > 11) {\n              $divLarge = this.$timelineLarge.appendDiv('scale-item').html('&nbsp;').data('count', 0);\n              first = 2;\n            } else {\n              $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'MMMM yyyy')).data('count', 0);\n              first = false;\n            }\n          } else {\n            if (first === 2) {\n              $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'MMMM yyyy')).data('count', 0);\n              first = false;\n            } else {\n              $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'MMMM')).data('count', 0);\n            }\n          }\n\n          newLargeGroup = true;\n        }\n\n        $divSmall = this.$timelineSmall.appendDiv('scale-item', dates.weekInYear(loop)).data('date-from', new Date(loop.valueOf())).data('tooltipText', this._scaleTooltipText.bind(this));\n\n        this._tooltipSupport.install($divSmall); // hide label\n\n\n        if (dates.weekInYear(loop) % labelPeriod !== 0) {\n          $divSmall.addClass('label-invisible');\n        }\n\n        loop.setDate(loop.getDate() + 7);\n\n        this._incrementTimelineScaleItems($divLarge, $divSmall, loop, newLargeGroup);\n      }\n    }\n  }, {\n    key: \"_renderYearScale\",\n    value: function _renderYearScale() {\n      var newLargeGroup,\n          $divLarge,\n          $divSmall,\n          first = true;\n      var loop = new Date(this.viewRange.from.valueOf());\n      var options = this.displayModeOptions[this.displayMode];\n      var labelPeriod = options.labelPeriod; // from start to end\n\n      while (loop < this.viewRange.to) {\n        newLargeGroup = false;\n\n        if (loop.getMonth() === 0 || first) {\n          $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'yyyy')).data('count', 0);\n          newLargeGroup = true;\n        }\n\n        $divSmall = this.$timelineSmall.appendDiv('scale-item', this._dateFormat(loop, 'MMMM')).data('date-from', new Date(loop.valueOf())); // hide label\n\n        if (loop.getMonth() % labelPeriod !== 0) {\n          $divSmall.addClass('label-invisible');\n        }\n\n        loop = dates.shift(loop, 0, 1, 0);\n\n        this._incrementTimelineScaleItems($divLarge, $divSmall, loop, newLargeGroup);\n\n        first = false;\n      }\n    }\n    /**\n     * @param {Date} newDate\n     */\n\n  }, {\n    key: \"_incrementTimelineScaleItems\",\n    value: function _incrementTimelineScaleItems($largeComp, $smallComp, newDate, newLargeGroup) {\n      $largeComp.data('count', $largeComp.data('count') + 1);\n      $smallComp.data('date-to', new Date(newDate.valueOf())).data('first', newLargeGroup);\n    }\n    /* -- scale events --------------------------------------------------- */\n\n  }, {\n    key: \"_scaleTooltipText\",\n    value: function _scaleTooltipText($scale) {\n      var toText = ' ' + this.session.text('ui.to') + ' ',\n          from = new Date($scale.data('date-from').valueOf()),\n          to = new Date($scale.data('date-to').valueOf() - 1);\n\n      if (from.getMonth() === to.getMonth()) {\n        return this._dateFormat(from, 'd.') + toText + this._dateFormat(to, 'd. MMMM yyyy');\n      } else if (from.getFullYear() === to.getFullYear()) {\n        return this._dateFormat(from, 'd. MMMM') + toText + this._dateFormat(to, 'd. MMMM yyyy');\n      }\n\n      return this._dateFormat(from, 'd. MMMM yyyy') + toText + this._dateFormat(to, 'd. MMMM yyyy');\n    }\n    /* --  render resources, activities --------------------------------- */\n\n  }, {\n    key: \"_removeAllResources\",\n    value: function _removeAllResources() {\n      this.resources.forEach(function (resource) {\n        resource.$resource.remove();\n      });\n    }\n  }, {\n    key: \"_renderResources\",\n    value: function _renderResources(resources) {\n      var i,\n          resource,\n          resourcesHtml = '';\n      resources = resources || this.resources;\n\n      for (i = 0; i < resources.length; i++) {\n        resource = resources[i];\n        resourcesHtml += this._buildResourceHtml(resource, this.$grid);\n      } // Append resources to grid\n\n\n      $(resourcesHtml).appendTo(this.$grid); // Match resources\n\n      this.$grid.children('.planner-resource').each(function (index, element) {\n        var $element = $(element);\n        resource = this._resourceById($element.attr('data-id'));\n\n        this._linkResource($element, resource);\n\n        this._linkActivitiesForResource(resource);\n      }.bind(this));\n    }\n  }, {\n    key: \"_linkResource\",\n    value: function _linkResource($resource, resource) {\n      $resource.data('resource', resource);\n      resource.$resource = $resource;\n      resource.$cells = $resource.children('.resource-cells');\n    }\n  }, {\n    key: \"_linkActivity\",\n    value: function _linkActivity($activity, activity) {\n      $activity.data('activity', activity);\n      activity.$activity = $activity;\n    }\n  }, {\n    key: \"_rerenderActivities\",\n    value: function _rerenderActivities(resources) {\n      resources = resources || this.resources;\n      resources.forEach(function (resource) {\n        this._removeActivitiesForResource(resource);\n\n        this._renderActivititesForResource(resource);\n      }, this);\n    }\n  }, {\n    key: \"_buildResourceHtml\",\n    value: function _buildResourceHtml(resource) {\n      var resourceHtml = '<div class=\"planner-resource\" data-id=\"' + resource.id + '\">';\n      resourceHtml += '<div class=\"resource-title\">' + strings.encode(resource.resourceCell.text || '') + '</div>';\n      resourceHtml += '<div class=\"resource-cells\">' + this._buildActivitiesHtml(resource) + '</div>';\n      resourceHtml += '</div>';\n      return resourceHtml;\n    }\n  }, {\n    key: \"_renderActivititesForResource\",\n    value: function _renderActivititesForResource(resource) {\n      resource.$cells.html(this._buildActivitiesHtml(resource));\n\n      this._linkActivitiesForResource(resource);\n    }\n  }, {\n    key: \"_linkActivitiesForResource\",\n    value: function _linkActivitiesForResource(resource) {\n      resource.$cells.children('.planner-activity').each(function (index, element) {\n        var $element = $(element);\n\n        var activity = this._activityById($element.attr('data-id'));\n\n        this._linkActivity($element, activity);\n      }.bind(this));\n    }\n  }, {\n    key: \"_buildActivitiesHtml\",\n    value: function _buildActivitiesHtml(resource) {\n      var activitiesHtml = '';\n      resource.activities.forEach(function (activity) {\n        if (activity.beginTime.valueOf() >= this.endScale || activity.endTime.valueOf() <= this.beginScale) {\n          // don't add activities which are not in the view range\n          return;\n        }\n\n        activitiesHtml += this._buildActivityHtml(activity);\n      }, this);\n      return activitiesHtml;\n    }\n  }, {\n    key: \"_removeActivitiesForResource\",\n    value: function _removeActivitiesForResource(resource) {\n      resource.activities.forEach(function (activity) {\n        if (activity.$activity) {\n          activity.$activity.remove();\n          activity.$activity = null;\n        }\n      }, this);\n    }\n  }, {\n    key: \"_buildActivityHtml\",\n    value: function _buildActivityHtml(activity) {\n      var level = 100 - Math.min(activity.level * 100, 100),\n          backgroundColor = styles.modelToCssColor(activity.backgroundColor),\n          foregroundColor = styles.modelToCssColor(activity.foregroundColor),\n          levelColor = styles.modelToCssColor(activity.levelColor),\n          begin = activity.beginTime.valueOf(),\n          end = activity.endTime.valueOf(); // Make sure activity fits into scale\n\n      begin = Math.max(begin, this.beginScale);\n      end = Math.min(end, this.endScale);\n      var activityCssClass = 'planner-activity' + (activity.cssClass ? ' ' + activity.cssClass : '');\n      var activityStyle = 'left: ' + 'calc(' + this.transformLeft(begin) + '% + 2px);';\n      activityStyle += ' width: ' + 'calc(' + this.transformWidth(begin, end) + '% - 4px);';\n\n      if (levelColor) {\n        activityStyle += ' background-color: ' + levelColor + ';';\n        activityStyle += ' border-color: ' + levelColor + ';';\n      }\n\n      if (!levelColor && backgroundColor) {\n        activityStyle += ' background-color: ' + backgroundColor + ';';\n        activityStyle += ' border-color: ' + backgroundColor + ';';\n      }\n\n      if (foregroundColor) {\n        activityStyle += ' color: ' + foregroundColor + ';';\n      } // The background-color represents the fill level and not the image. This makes it easier to change the color using a css class\n      // In order to change the background rather than the fill, use the planner-activity-level css class\n\n\n      var activityLevelCssClass = 'planner-activity-level' + (activity.cssClass ? ' ' + activity.cssClass : '');\n      var activityEmptyColor = styles.get(activityLevelCssClass, 'background-color').backgroundColor;\n      activityStyle += ' background-image: ' + 'linear-gradient(to bottom, ' + activityEmptyColor + ' 0%, ' + activityEmptyColor + ' ' + level + '%, transparent ' + level + '%, transparent 100% );';\n      var activityHtml = '<div';\n      activityHtml += ' class=\"' + activityCssClass + '\"';\n      activityHtml += ' style=\"' + activityStyle + '\"';\n      activityHtml += ' data-id=\"' + activity.id + '\"';\n      activityHtml += '>' + strings.encode(activity.text || '') + '</div>';\n      return activityHtml;\n    }\n    /* -- selector -------------------------------------------------- */\n\n  }, {\n    key: \"_onCellMouseDown\",\n    value: function _onCellMouseDown(event) {\n      var $activity,\n          $resource,\n          $target = $(event.target),\n          selectionMode = Planner.SelectionMode,\n          opensContextMenu = event.which === 3 || event.which === 1 && event.ctrlKey;\n\n      if (this.activitySelectable) {\n        if (!opensContextMenu && this.$selector) {\n          // Hide selector otherwise activity may not be resolved (elementFromPoint would return the $selector)\n          // This allows selecting an activity which is inside a selection range\n          this.$selector.hide();\n        }\n\n        $activity = this.$grid.elementFromPoint(event.pageX, event.pageY);\n\n        if (!opensContextMenu && this.$selector) {\n          this.$selector.show();\n        }\n\n        if ($activity.hasClass('planner-activity')) {\n          $resource = $activity.parent().parent();\n          this.selectResources([$resource.data('resource')]);\n          this.selectActivity($activity.data('activity'));\n          this.selectRange(new DateRange());\n        } else {\n          this.selectActivity(null);\n        }\n      } else {\n        this.selectActivity(null);\n      }\n\n      if (this.selectionMode === selectionMode.NONE) {\n        return;\n      }\n\n      if ($target.hasClass('selector') && opensContextMenu) {\n        // Right click on the selector must not clear the selection -> context menu will be opened\n        return;\n      }\n\n      if (!this.selectedActivity) {\n        // If not an activity was selected, start immediately, otherwise start as soon the mouse moves\n        this._startRangeSelection(event.pageX, event.pageY);\n      } // add event handlers\n\n\n      this._cellMousemoveHandler = this._onCellMousemove.bind(this, event);\n      $target.document().on('mousemove', this._cellMousemoveHandler).one('mouseup', this._onDocumentMouseUp.bind(this));\n    }\n  }, {\n    key: \"_startRangeSelection\",\n    value: function _startRangeSelection(pageX, pageY) {\n      // init selector\n      this.startRow = this._findRow(pageY);\n      this.lastRow = this.startRow; // find range on scale\n\n      this.startRange = this._findScale(pageX);\n      this.lastRange = this.startRange; // draw\n\n      this._select(true);\n\n      this._rangeSelectionStarted = true;\n    }\n    /**\n     * @returns {boolean} true if the range selection may be started, false if not\n     */\n\n  }, {\n    key: \"_prepareRangeSelectionByMousemove\",\n    value: function _prepareRangeSelectionByMousemove(mousedownEvent, mousemoveEvent) {\n      var moveX = mousedownEvent.pageX - mousemoveEvent.pageX;\n      var moveY = mousedownEvent.pageY - mousemoveEvent.pageY;\n      var moveThreshold = Planner.RANGE_SELECTION_MOVE_THRESHOLD;\n\n      if (Math.abs(moveX) >= moveThreshold) {\n        // Accept if x movement is big enough\n        return true;\n      }\n\n      var mousedownRow = this._findRow(mousedownEvent.pageY);\n\n      var mousemoveRow = this._findRow(mousemoveEvent.pageY); // Accept if y movement is big enough AND the row changed. No need to switch into range selection mode if cursor is still on the same row\n\n\n      return Math.abs(moveY) >= moveThreshold && this.selectionMode === Planner.SelectionMode.MULTI_RANGE && mousedownRow !== mousemoveRow;\n    }\n  }, {\n    key: \"_onCellMousemove\",\n    value: function _onCellMousemove(mousedownEvent, event) {\n      if (this.selectedActivity && !this._rangeSelectionStarted) {\n        // If an activity was selected, switch to range selection if the user moves the mouse\n        if (!this._prepareRangeSelectionByMousemove(mousedownEvent, event)) {\n          return;\n        }\n\n        this._startRangeSelection(mousedownEvent.pageX, mousedownEvent.pageY);\n      }\n\n      var lastRow = this._findRow(event.pageY);\n\n      if (lastRow) {\n        this.lastRow = lastRow;\n      }\n\n      var lastRange = this._findScale(event.pageX);\n\n      if (lastRange) {\n        this.lastRange = lastRange;\n      }\n\n      this._select(true);\n    }\n  }, {\n    key: \"_onResizeMouseDown\",\n    value: function _onResizeMouseDown(event) {\n      var swap,\n          $target = $(event.target);\n      this.startRow = this.selectedResources[0];\n      this.lastRow = this.selectedResources[this.selectedResources.length - 1]; // Get the start and last range based on the clicked resize handle. If the ranges cannot be determined it likely means that the selectionRange is out of the current viewRange or dayRange (set by firstHourOfDay, lastHourOfDay)\n\n      this.startRange = scout.nvl(this._findScaleByFromDate(this.selectionRange.from), new Range(this.selectionRange.from.getTime(), this.selectionRange.from.getTime()));\n      this.lastRange = scout.nvl(this._findScaleByToDate(this.selectionRange.to), new Range(this.selectionRange.to.getTime(), this.selectionRange.to.getTime())); // Swap start and last range if resize-left is clicked\n\n      if ($target.hasClass('selector-resize-left')) {\n        swap = this.startRange;\n        this.startRange = this.lastRange;\n        this.lastRange = swap;\n      }\n\n      $target.body().addClass('col-resize');\n      this._resizeMousemoveHandler = this._onResizeMousemove.bind(this);\n      $target.document().on('mousemove', this._resizeMousemoveHandler).one('mouseup', this._onDocumentMouseUp.bind(this));\n      return false;\n    }\n  }, {\n    key: \"_onResizeMousemove\",\n    value: function _onResizeMousemove(event) {\n      if (!this.rendered) {\n        // planner may be removed in the meantime\n        return;\n      }\n\n      var lastRange = this._findScale(event.pageX);\n\n      if (lastRange) {\n        this.lastRange = lastRange;\n      }\n\n      this._select(true);\n    }\n  }, {\n    key: \"_onDocumentMouseUp\",\n    value: function _onDocumentMouseUp(event) {\n      var $target = $(event.target);\n      $target.body().removeClass('col-resize');\n\n      if (this._cellMousemoveHandler) {\n        $target.document().off('mousemove', this._documentMousemoveHandler);\n        this._cellMousemoveHandler = null;\n      }\n\n      if (this._resizeMousemoveHandler) {\n        $target.document().off('mousemove', this._resizeMousemoveHandler);\n        this._resizeMousemoveHandler = null;\n      }\n\n      if (!this._rangeSelectionStarted) {\n        // Range selection has not been initiated -> don't call select()\n        return;\n      }\n\n      this._rangeSelectionStarted = false;\n\n      if (this.rendered) {\n        this._select();\n      }\n    }\n  }, {\n    key: \"_select\",\n    value: function _select(whileSelecting) {\n      if (!this.startRow || !this.lastRow) {\n        return;\n      }\n\n      var rangeSelected = !!(this.startRange && this.lastRange);\n      var $startRow = this.startRow.$resource,\n          $lastRow = this.lastRow.$resource; // in case of single selection\n\n      if (this.selectionMode === Planner.SelectionMode.SINGLE_RANGE) {\n        this.lastRow = this.startRow;\n        $lastRow = this.startRow.$resource;\n      } // select rows\n\n\n      var $upperRow = $startRow[0].offsetTop <= $lastRow[0].offsetTop ? $startRow : $lastRow,\n          $lowerRow = $startRow[0].offsetTop > $lastRow[0].offsetTop ? $startRow : $lastRow,\n          resources = $('.planner-resource', this.$grid).toArray(),\n          top = $upperRow[0].offsetTop,\n          low = $lowerRow[0].offsetTop;\n\n      for (var r = resources.length - 1; r >= 0; r--) {\n        var row = resources[r];\n\n        if (row.offsetTop < top && row.offsetTop < low || row.offsetTop > top && row.offsetTop > low) {\n          resources.splice(r, 1);\n        }\n      }\n\n      this.selectResources(resources.map(function (i) {\n        return $(i).data('resource');\n      }), !whileSelecting);\n      this.selectActivity(null);\n\n      if (rangeSelected) {\n        // left and width\n        var from = Math.min(this.lastRange.from, this.startRange.from),\n            to = Math.max(this.lastRange.to, this.startRange.to);\n        var selectionRange = new DateRange(new Date(from), new Date(to));\n        selectionRange = this._adjustSelectionRange(selectionRange);\n        this.selectRange(selectionRange, !whileSelecting);\n      }\n    }\n  }, {\n    key: \"_adjustSelectionRange\",\n    value: function _adjustSelectionRange(range) {\n      var from = range.from.getTime();\n      var to = range.to.getTime(); // Ensure minimum size of selection range (interval is in minutes)\n\n      var minSelectionDuration = 0;\n      var options = this.displayModeOptions[this.displayMode];\n\n      if (options.interval > 0 && options.minSelectionIntervalCount > 0) {\n        minSelectionDuration = options.minSelectionIntervalCount * options.interval * 60000;\n      }\n\n      var lastHourOfDay = options.lastHourOfDay;\n      var endOfDay = dates.shiftTime(dates.trunc(range.from), lastHourOfDay + 1);\n\n      var viewRange = this._visibleViewRange();\n\n      if (this.lastRange.from < this.startRange.from) {\n        // Selecting to left\n        if (to - minSelectionDuration >= viewRange.from.getTime()) {\n          // extend to left side\n          from = Math.min(from, to - minSelectionDuration);\n        } else {\n          // extend to right side if from would be smaller than the minimum date (left border)\n          from = viewRange.from.getTime();\n          to = Math.max(to, Math.min(from + minSelectionDuration, viewRange.to.getTime()));\n        }\n      } else {\n        // Selecting to right\n        if (from + minSelectionDuration <= viewRange.to.getTime()) {\n          // extend to right side\n          to = Math.max(to, Math.max(from + minSelectionDuration, viewRange.from.getTime()));\n\n          if (to >= endOfDay.getTime() && new Range(from, to).size() === minSelectionDuration) {\n            // extend to left side when clicking at the end of a day\n            to = endOfDay.getTime();\n            from = Math.min(from, to - minSelectionDuration);\n          }\n        } else {\n          // extend to left side if to would be greater than the maximum date (right border)\n          to = viewRange.to.getTime();\n          from = Math.min(from, to - minSelectionDuration);\n        }\n      }\n\n      return new DateRange(new Date(from), new Date(to));\n    }\n  }, {\n    key: \"_findRow\",\n    value: function _findRow(y) {\n      var $row,\n          gridBounds = graphics.offsetBounds(this.$grid),\n          x = gridBounds.x + 10;\n      y = Math.min(Math.max(y, 0), gridBounds.y + gridBounds.height - 1);\n      $row = this.$container.elementFromPoint(x, y, '.planner-resource');\n\n      if ($row.length > 0) {\n        return $row.data('resource');\n      }\n\n      return null;\n    }\n  }, {\n    key: \"_findScale\",\n    value: function _findScale(x) {\n      var $scaleItem,\n          gridBounds = graphics.offsetBounds(this.$grid),\n          y = this.$scale.offset().top + this.$scale.height() * 0.75;\n      x = Math.min(Math.max(x, 0), gridBounds.x + gridBounds.width - 1);\n      $scaleItem = this.$container.elementFromPoint(x, y, '.scale-item');\n\n      if ($scaleItem.length > 0) {\n        return new DateRange($scaleItem.data('date-from').valueOf(), $scaleItem.data('date-to').valueOf());\n      }\n\n      return null;\n    }\n  }, {\n    key: \"_findScaleByFromDate\",\n    value: function _findScaleByFromDate(from) {\n      return this._findScaleByFunction(function (i, elem) {\n        var $scaleItem = $(elem);\n\n        if ($scaleItem.data('date-from').getTime() === from.getTime()) {\n          return true;\n        }\n      });\n    }\n  }, {\n    key: \"_findScaleByToDate\",\n    value: function _findScaleByToDate(to) {\n      return this._findScaleByFunction(function (i, elem) {\n        var $scaleItem = $(elem);\n\n        if ($scaleItem.data('date-to').getTime() === to.getTime()) {\n          return true;\n        }\n      });\n    }\n  }, {\n    key: \"_findScaleByFunction\",\n    value: function _findScaleByFunction(func) {\n      var $scaleItem = this.$timelineSmall.children('.scale-item').filter(func);\n\n      if (!$scaleItem.length) {\n        return null;\n      }\n\n      return new DateRange($scaleItem.data('date-from').valueOf(), $scaleItem.data('date-to').valueOf());\n    }\n    /**\n     * @returns {Range} the visible view range (the difference to this.viewRange is that first and last hourOfDay are considered).\n     */\n\n  }, {\n    key: \"_visibleViewRange\",\n    value: function _visibleViewRange() {\n      var $items = this.$timelineSmall.children('.scale-item');\n      return new Range($items.first().data('date-from'), $items.last().data('date-to'));\n    }\n    /* -- helper ---------------------------------------------------- */\n\n    /**\n     * @param {Date} date\n     */\n\n  }, {\n    key: \"_dateFormat\",\n    value: function _dateFormat(date, pattern) {\n      var d = new Date(date.valueOf()),\n          dateFormat = new DateFormat(this.session.locale, pattern);\n      return dateFormat.format(d);\n    }\n  }, {\n    key: \"_renderViewRange\",\n    value: function _renderViewRange() {\n      this._renderRange();\n\n      this._renderScale();\n\n      this.invalidateLayoutTree();\n    }\n  }, {\n    key: \"_renderHeaderVisible\",\n    value: function _renderHeaderVisible() {\n      this._header.setVisible(this.headerVisible);\n\n      this.invalidateLayoutTree();\n    }\n  }, {\n    key: \"_renderYearPanelVisible\",\n    value: function _renderYearPanelVisible(animated) {\n      var yearPanelWidth;\n\n      if (this.yearPanelVisible) {\n        this._yearPanel.renderContent();\n      } // show or hide year panel\n\n\n      $('.calendar-toggle-year', this.$modes).select(this.yearPanelVisible);\n\n      if (this.yearPanelVisible) {\n        yearPanelWidth = 210;\n      } else {\n        yearPanelWidth = 0;\n      }\n\n      this._yearPanel.$container.animate({\n        width: yearPanelWidth\n      }, {\n        duration: animated ? 500 : 0,\n        progress: this._onYearPanelWidthChange.bind(this),\n        complete: this._afterYearPanelWidthChange.bind(this)\n      });\n    }\n  }, {\n    key: \"_onYearPanelWidthChange\",\n    value: function _onYearPanelWidthChange() {\n      if (!this._yearPanel.$container) {\n        // If container has been removed in the meantime (e.g. user navigates away while animation is in progress)\n        return;\n      }\n\n      var yearPanelWidth = this._yearPanel.$container.outerWidth();\n\n      this.$grid.css('width', 'calc(100% - ' + yearPanelWidth + 'px)');\n      this.$scale.css('width', 'calc(100% - ' + yearPanelWidth + 'px)');\n      this.revalidateLayout();\n    }\n  }, {\n    key: \"_afterYearPanelWidthChange\",\n    value: function _afterYearPanelWidthChange() {\n      if (!this.yearPanelVisible) {\n        this._yearPanel.removeContent();\n      }\n    }\n  }, {\n    key: \"_setMenus\",\n    value: function _setMenus(menus) {\n      this.updateKeyStrokes(menus, this.menus);\n\n      this._setProperty('menus', menus);\n\n      this._updateMenuBar();\n    }\n  }, {\n    key: \"_updateMenuBar\",\n    value: function _updateMenuBar() {\n      var menuItems = this._filterMenus(['Planner.EmptySpace', 'Planner.Resource', 'Planner.Activity', 'Planner.Range'], false, true);\n\n      this.menuBar.setMenuItems(menuItems);\n    }\n  }, {\n    key: \"_removeMenus\",\n    value: function _removeMenus() {// menubar takes care about removal\n    }\n  }, {\n    key: \"_filterMenus\",\n    value: function _filterMenus(allowedTypes, onlyVisible, enableDisableKeyStroke) {\n      allowedTypes = allowedTypes || [];\n\n      if (allowedTypes.indexOf('Planner.Resource') > -1 && this.selectedResources.length === 0) {\n        arrays.remove(allowedTypes, 'Planner.Resource');\n      }\n\n      if (allowedTypes.indexOf('Planner.Activity') > -1 && !this.selectedActivity) {\n        arrays.remove(allowedTypes, 'Planner.Activity');\n      }\n\n      if (allowedTypes.indexOf('Planner.Range') > -1 && !this.selectionRange.from && !this.selectionRange.to) {\n        arrays.remove(allowedTypes, 'Planner.Range');\n      }\n\n      return menus_1.filter(this.menus, allowedTypes, onlyVisible, enableDisableKeyStroke);\n    }\n  }, {\n    key: \"setDisplayModeOptions\",\n    value: function setDisplayModeOptions(displayModeOptions) {\n      this.setProperty('displayModeOptions', displayModeOptions);\n    }\n  }, {\n    key: \"_setDisplayModeOptions\",\n    value: function _setDisplayModeOptions(displayModeOptions) {\n      if (displayModeOptions) {\n        this._adjustHours(displayModeOptions);\n      }\n\n      this.displayModeOptions = displayModeOptions;\n    }\n    /**\n     * Make sure configured our is between 0 and 23.\n     */\n\n  }, {\n    key: \"_adjustHours\",\n    value: function _adjustHours(optionsMap) {\n      objects.values(optionsMap).forEach(function (options) {\n        if (options.firstHourOfDay) {\n          options.firstHourOfDay = validHour(options.firstHourOfDay);\n        }\n\n        if (options.lastHourOfDay) {\n          options.lastHourOfDay = validHour(options.lastHourOfDay);\n        }\n      });\n\n      function validHour(hour) {\n        if (hour < 0) {\n          return 0;\n        }\n\n        if (hour > 23) {\n          return 23;\n        }\n\n        return hour;\n      }\n    }\n  }, {\n    key: \"_renderDisplayModeOptions\",\n    value: function _renderDisplayModeOptions() {\n      this._renderRange();\n\n      this._renderScale();\n\n      this._rerenderActivities(); // required in case first/lastHourOfDay changes\n\n\n      this._select(); // adjust selection if minSelectionIntervalCount has changed\n\n\n      this.invalidateLayoutTree();\n    }\n  }, {\n    key: \"_renderAvailableDisplayModes\",\n    value: function _renderAvailableDisplayModes() {// done by PlannerHeader.js\n    }\n  }, {\n    key: \"_renderDisplayMode\",\n    value: function _renderDisplayMode() {// done by PlannerHeader.js\n    }\n  }, {\n    key: \"_setViewRange\",\n    value: function _setViewRange(viewRange) {\n      viewRange = DateRange.ensure(viewRange);\n\n      this._setProperty('viewRange', viewRange);\n\n      this._yearPanel.setViewRange(this.viewRange);\n\n      this._yearPanel.selectDate(this.viewRange.from);\n    }\n  }, {\n    key: \"_setDisplayMode\",\n    value: function _setDisplayMode(displayMode) {\n      this._setProperty('displayMode', displayMode);\n\n      this._yearPanel.setDisplayMode(this.displayMode);\n\n      this._header.setDisplayMode(this.displayMode);\n    }\n  }, {\n    key: \"_setAvailableDisplayModes\",\n    value: function _setAvailableDisplayModes(availableDisplayModes) {\n      this._setProperty('availableDisplayModes', availableDisplayModes);\n\n      this._header.setAvailableDisplayModes(this.availableDisplayModes);\n    }\n  }, {\n    key: \"_setSelectionRange\",\n    value: function _setSelectionRange(selectionRange) {\n      selectionRange = DateRange.ensure(selectionRange);\n\n      this._setProperty('selectionRange', selectionRange);\n\n      this.session.onRequestsDone(this._updateMenuBar.bind(this));\n    }\n  }, {\n    key: \"_setSelectedResources\",\n    value: function _setSelectedResources(selectedResources) {\n      if (typeof selectedResources[0] === 'string') {\n        selectedResources = this._resourcesByIds(selectedResources);\n      }\n\n      if (this.rendered) {\n        this._removeSelectedResources();\n      }\n\n      this._setProperty('selectedResources', selectedResources);\n\n      this.session.onRequestsDone(this._updateMenuBar.bind(this));\n    }\n  }, {\n    key: \"_removeSelectedResources\",\n    value: function _removeSelectedResources() {\n      this.selectedResources.forEach(function (resource) {\n        resource.$resource.select(false);\n      });\n    }\n  }, {\n    key: \"_renderSelectedResources\",\n    value: function _renderSelectedResources() {\n      this.selectedResources.forEach(function (resource) {\n        resource.$resource.select(true);\n      });\n    }\n  }, {\n    key: \"_renderActivitySelectable\",\n    value: function _renderActivitySelectable() {\n      if (this.selectedActivity && this.selectedActivity.$activity) {\n        this.selectedActivity.$activity.toggleClass('selected', this.activitySelectable);\n      }\n    }\n  }, {\n    key: \"_renderSelectionMode\",\n    value: function _renderSelectionMode() {\n      if (this.selectionMode === Planner.SelectionMode.NONE) {\n        if (this.$selector) {\n          this.$selector.remove();\n          this.$highlight.remove();\n        }\n      } else {\n        this._renderSelectionRange();\n      }\n    }\n  }, {\n    key: \"_renderSelectionRange\",\n    value: function _renderSelectionRange() {\n      var $startRow,\n          $lastRow,\n          from = this.selectionRange.from,\n          to = this.selectionRange.to,\n          startRow = this.selectedResources[0],\n          lastRow = this.selectedResources[this.selectedResources.length - 1]; // remove old selector\n\n      if (this.$selector) {\n        this.$selector.remove();\n        this.$highlight.remove();\n      }\n\n      if (!startRow || !lastRow || !this.selectionRange.from || !this.selectionRange.to) {\n        return;\n      }\n\n      $startRow = startRow.$resource;\n      $lastRow = lastRow.$resource; // Make sure selection fits into scale\n\n      from = Math.max(from, this.beginScale);\n      to = Math.min(to, this.endScale); // top and height\n\n      var $parent = $startRow[0].offsetTop <= $lastRow[0].offsetTop ? $startRow : $lastRow;\n      this.$selector = $parent.children('.resource-cells').appendDiv('selector');\n      this.$selector.cssHeight($startRow.outerHeight() + Math.abs($lastRow[0].offsetTop - $startRow[0].offsetTop));\n      var $selectorResizeLeft = this.$selector.appendDiv('selector-resize-left').mousedown(this._onResizeMouseDown.bind(this));\n      var $selectorResizeRight = this.$selector.appendDiv('selector-resize-right').mousedown(this._onResizeMouseDown.bind(this));\n      this.$selector.css('left', 'calc(' + this.transformLeft(from) + '% - ' + $selectorResizeLeft.cssWidth() + 'px)').css('width', 'calc(' + this.transformWidth(from, to) + '% + ' + ($selectorResizeLeft.cssWidth() + $selectorResizeRight.cssWidth()) + 'px)').on('contextmenu', this._onRangeSelectorContextMenu.bind(this)); // colorize scale\n\n      this.$highlight = this.$timelineSmall.prependDiv('highlight');\n      var left = this.$selector.cssLeft() + $selectorResizeLeft.cssWidth() + this.$scaleTitle.cssWidth();\n      var width = this.$selector.cssWidth() - ($selectorResizeLeft.cssWidth() + $selectorResizeRight.cssWidth());\n      this.$highlight.cssLeft(left).cssWidth(width);\n    }\n  }, {\n    key: \"_setSelectedActivity\",\n    value: function _setSelectedActivity(selectedActivity) {\n      if (typeof selectedActivity === 'string') {\n        selectedActivity = this._activityById(selectedActivity);\n      }\n\n      if (this.rendered) {\n        this._removeSelectedActivity();\n      }\n\n      this._setProperty('selectedActivity', selectedActivity);\n\n      this.session.onRequestsDone(this._updateMenuBar.bind(this));\n    }\n  }, {\n    key: \"_removeSelectedActivity\",\n    value: function _removeSelectedActivity() {\n      if (this.selectedActivity && this.selectedActivity.$activity) {\n        this.selectedActivity.$activity.removeClass('selected');\n      }\n    }\n  }, {\n    key: \"_renderSelectedActivity\",\n    value: function _renderSelectedActivity() {\n      if (this.selectedActivity && this.selectedActivity.$activity) {\n        this.selectedActivity.$activity.addClass('selected');\n      }\n    }\n  }, {\n    key: \"_renderLabel\",\n    value: function _renderLabel() {\n      var label = this.label || '';\n\n      if (this.$scaleTitle) {\n        this.$scaleTitle.text(label);\n      }\n    }\n  }, {\n    key: \"_resourcesByIds\",\n    value: function _resourcesByIds(ids) {\n      return ids.map(this._resourceById.bind(this));\n    }\n  }, {\n    key: \"_activityById\",\n    value: function _activityById(id) {\n      return this.activityMap[id];\n    }\n  }, {\n    key: \"_resourceById\",\n    value: function _resourceById(id) {\n      return this.resourceMap[id];\n    }\n  }, {\n    key: \"setDisplayMode\",\n    value: function setDisplayMode(displayMode) {\n      this.setProperty('displayMode', displayMode);\n      this.startRange = null;\n      this.lastRange = null;\n    }\n  }, {\n    key: \"layoutYearPanel\",\n    value: function layoutYearPanel() {\n      if (this.yearPanelVisible) {\n        scrollbars.update(this._yearPanel.$yearList);\n\n        this._yearPanel._scrollYear();\n      }\n    }\n  }, {\n    key: \"setYearPanelVisible\",\n    value: function setYearPanelVisible(visible) {\n      if (this.yearPanelVisible === visible) {\n        return;\n      }\n\n      this._setProperty('yearPanelVisible', visible);\n\n      if (this.rendered) {\n        this._renderYearPanelVisible(true);\n      }\n    }\n  }, {\n    key: \"setViewRangeFrom\",\n    value: function setViewRangeFrom(date) {\n      var diff = this.viewRange.to.getTime() - this.viewRange.from.getTime(),\n          viewRange = new DateRange(this.viewRange.from, this.viewRange.to);\n      viewRange.from = date;\n      viewRange.to = new Date(date.getTime() + diff);\n      this.setViewRange(viewRange);\n    }\n  }, {\n    key: \"setViewRange\",\n    value: function setViewRange(viewRange) {\n      if (this.viewRange === viewRange) {\n        return;\n      }\n\n      this._setViewRange(viewRange);\n\n      if (this.rendered) {\n        this._renderViewRange();\n\n        this._rerenderActivities();\n\n        this._renderSelectedActivity();\n\n        this.validateLayoutTree();\n      }\n    }\n  }, {\n    key: \"selectRange\",\n    value: function selectRange(range) {\n      if (range && range.equals(this.selectionRange)) {\n        return;\n      }\n\n      this.setProperty('selectionRange', range);\n    }\n  }, {\n    key: \"selectActivity\",\n    value: function selectActivity(activity) {\n      this.setProperty('selectedActivity', activity);\n    }\n  }, {\n    key: \"selectResources\",\n    value: function selectResources(resources) {\n      if (arrays.equals(resources, this.selectedResources)) {\n        return;\n      }\n\n      resources = arrays.ensure(resources); // Make a copy so that original array stays untouched\n\n      resources = resources.slice();\n      this.setProperty('selectedResources', resources);\n      this.trigger('resourcesSelected', {\n        resources: resources\n      });\n\n      if (this.rendered) {\n        // Render selection range as well for the case if selectedRange does not change but selected resources do\n        this._renderSelectionRange();\n      }\n    }\n    /**\n     * Returns true if a deselection happened. False if the given resources were not selected at all.\n     */\n\n  }, {\n    key: \"deselectResources\",\n    value: function deselectResources(resources) {\n      var deselected = false;\n      resources = arrays.ensure(resources);\n      var selectedResources = this.selectedResources.slice(); // copy\n\n      if (arrays.removeAll(selectedResources, resources)) {\n        this.selectResources(selectedResources);\n        deselected = true;\n      }\n\n      return deselected;\n    }\n  }, {\n    key: \"insertResources\",\n    value: function insertResources(resources) {\n      // Update model\n      resources.forEach(function (resource) {\n        this._initResource(resource); // Always insert new rows at the end, if the order is wrong a rowOrderChanged event will follow\n\n\n        this.resources.push(resource);\n      }.bind(this)); // Update HTML\n\n      if (this.rendered) {\n        this._renderResources(resources);\n\n        this.invalidateLayoutTree();\n      }\n    }\n  }, {\n    key: \"deleteResources\",\n    value: function deleteResources(resources) {\n      if (this.deselectResources(resources)) {\n        this.selectRange(new DateRange());\n      }\n\n      resources.forEach(function (resource) {\n        // Update model\n        arrays.remove(this.resources, resource);\n        delete this.resourceMap[resource.id];\n        resource.activities.forEach(function (activity) {\n          delete this.activityMap[activity.id];\n        }.bind(this)); // Update HTML\n\n        if (this.rendered) {\n          resource.$resource.remove();\n          delete resource.$resource;\n        }\n      }.bind(this));\n      this.invalidateLayoutTree();\n    }\n  }, {\n    key: \"deleteAllResources\",\n    value: function deleteAllResources() {\n      // Update HTML\n      if (this.rendered) {\n        this._removeAllResources();\n\n        this.invalidateLayoutTree();\n      } // Update model\n\n\n      this.resources = [];\n      this.resourceMap = {};\n      this.activityMap = {};\n      this.selectResources([]);\n      this.selectRange(new DateRange());\n    }\n  }, {\n    key: \"updateResources\",\n    value: function updateResources(resources) {\n      resources.forEach(function (updatedResource) {\n        var oldResource = this.resourceMap[updatedResource.id];\n\n        if (!oldResource) {\n          throw new Error('Update event received for non existing resource. ResourceId: ' + updatedResource.id);\n        } // Replace old resource\n\n\n        this._initResource(updatedResource);\n\n        arrays.replace(this.resources, oldResource, updatedResource);\n        arrays.replace(this.selectedResources, oldResource, updatedResource); // Replace old $resource\n\n        if (this.rendered && oldResource.$resource) {\n          var $updatedResource = $(this._buildResourceHtml(updatedResource));\n          oldResource.$resource.replaceWith($updatedResource);\n          $updatedResource.css('min-width', oldResource.$resource.css('min-width'));\n\n          this._linkResource($updatedResource, updatedResource);\n\n          this._linkActivitiesForResource(updatedResource);\n        }\n      }.bind(this));\n    }\n  }]);\n\n  return Planner;\n}(Widget);\n\n_defineProperty(Planner, \"Direction\", {\n  BACKWARD: -1,\n  FORWARD: 1\n});\n\n_defineProperty(Planner, \"DisplayMode\", {\n  DAY: 1,\n  WEEK: 2,\n  MONTH: 3,\n  WORK_WEEK: 4,\n  CALENDAR_WEEK: 5,\n  YEAR: 6\n});\n\n_defineProperty(Planner, \"SelectionMode\", {\n  NONE: 0,\n  SINGLE_RANGE: 1,\n  MULTI_RANGE: 2\n});\n\n_defineProperty(Planner, \"RANGE_SELECTION_MOVE_THRESHOLD\", 10);\n\nexport { Planner as default };","map":{"version":3,"sources":["C:/Tools/workspace/nightstalker/nightstalker.ui.html/node_modules/@eclipse-scout/core/src/planner/Planner.js"],"names":["arrays","DateFormat","DateRange","dates","defaultValues","graphics","HtmlComponent","KeyStrokeContext","MenuBar","menus","menus_1","objects","PlannerLayout","PlannerMenuItemsOrder","Range","scout","scrollbars","strings","styles","tooltips","TooltipSupport","Widget","$","Planner","activityMap","activitySelectable","availableDisplayModes","displayMode","displayModeOptions","headerVisible","label","resources","resourceMap","selectionMode","SelectionMode","MULTI_RANGE","selectionRange","selectedResources","viewRange","selectedActivity","_resourceTitleWidth","_rangeSelectionStarted","startRow","lastRow","$container","$range","$modes","$grid","transformLeft","t","transformWidth","t0","t1","yearPanelVisible","_addWidgetProperties","model","_yearPanel","create","parent","alwaysSelectFirstDay","on","_onYearPanelDateSelect","bind","_header","_onTodayClick","_onYearClick","_onPreviousClick","_onNextClick","_onDisplayModeClick","menuBar","position","Position","BOTTOM","menuOrder","session","i","length","_initResource","_setDisplayMode","_setAvailableDisplayModes","_setViewRange","_setSelectedResources","_setSelectedActivity","_setSelectionRange","_setMenus","_setDisplayModeOptions","_tooltipSupport","arrowPosition","resource","applyTo","activities","forEach","activity","_initActivity","id","beginTime","parseJsonDate","endTime","$parent","appendDiv","layout","htmlComp","install","setLayout","render","_onCellMouseDown","_onResourceTitleMouseDown","_onResourceTitleContextMenu","_onActivityContextMenu","$scale","selector","text","$comp","_activityById","attr","tooltipText","undefined","_installScrollbars","_gridScrollHandler","_onGridScroll","_renderViewRange","_renderHeaderVisible","_renderYearPanelVisible","_renderResources","_renderSelectedActivity","_renderSelectedResources","setTimeout","_renderSelectionRange","event","_navigateDate","Direction","BACKWARD","FORWARD","direction","from","to","DisplayMode","DAY","shift","isOneOf","WEEK","WORK_WEEK","ensureMonday","MONTH","CALENDAR_WEEK","YEAR","setViewRange","today","Date","year","getFullYear","month","getMonth","date","getDate","day","getDay","setViewRangeFrom","setDisplayMode","setYearPanelVisible","$resource","target","isSelected","which","ctrlKey","data","_select","_showContextMenu","allowedType","preventDefault","stopPropagation","func","rendered","attached","filteredMenus","_filterMenus","$part","currentTarget","popup","menuItems","location","x","pageX","y","pageY","$anchor","open","onRequestsDone","_reconcileScrollPos","scrollLeft","toDate","valueOf","toText","isSameDay","_dateFormat","join","width","that","empty","children","remove","$scaleTitle","_renderLabel","$timeline","$timelineLarge","$timelineSmall","_renderDayScale","_renderWeekScale","_renderMonthScale","_renderCalendarWeekScale","_renderYearScale","$smallScaleItems","$largeScaleItems","each","$scaleItem","$largeGridLine","prependDiv","css","index","$smallGridLine","beginScale","first","endScale","last","options","interval","firstHourOfDay","lastHourOfDay","begin","end","firstHour","lastHour","fullRangeMillis","dayDiffTBegin","compareDays","dayDIffEndBegin","dayComponentMillis","rangeScaling","dayOffset","getHours","hiddenRanges","_findHiddenRangesInWeekMode","selectedRangeMillis","subtractAll","reduce","acc","range","size","ranges","currentDate","hiddenRange","shiftTime","push","setHours","setMinutes","setDate","newLargeGroup","$divLarge","$divSmall","loop","labelPeriod","Math","min","getMinutes","addClass","_incrementTimelineScaleItems","html","weekInYear","_scaleTooltipText","$largeComp","$smallComp","newDate","resourcesHtml","_buildResourceHtml","appendTo","element","$element","_resourceById","_linkResource","_linkActivitiesForResource","$cells","$activity","_removeActivitiesForResource","_renderActivititesForResource","resourceHtml","encode","resourceCell","_buildActivitiesHtml","_linkActivity","activitiesHtml","_buildActivityHtml","level","backgroundColor","modelToCssColor","foregroundColor","levelColor","max","activityCssClass","cssClass","activityStyle","activityLevelCssClass","activityEmptyColor","get","activityHtml","$target","opensContextMenu","$selector","hide","elementFromPoint","show","hasClass","selectResources","selectActivity","selectRange","NONE","_startRangeSelection","_cellMousemoveHandler","_onCellMousemove","document","one","_onDocumentMouseUp","_findRow","startRange","_findScale","lastRange","mousedownEvent","mousemoveEvent","moveX","moveY","moveThreshold","RANGE_SELECTION_MOVE_THRESHOLD","abs","mousedownRow","mousemoveRow","_prepareRangeSelectionByMousemove","swap","nvl","_findScaleByFromDate","getTime","_findScaleByToDate","body","_resizeMousemoveHandler","_onResizeMousemove","removeClass","off","_documentMousemoveHandler","whileSelecting","rangeSelected","$startRow","$lastRow","SINGLE_RANGE","$upperRow","offsetTop","$lowerRow","toArray","top","low","r","row","splice","map","_adjustSelectionRange","minSelectionDuration","minSelectionIntervalCount","endOfDay","trunc","_visibleViewRange","$row","gridBounds","offsetBounds","height","offset","_findScaleByFunction","elem","filter","$items","pattern","d","dateFormat","locale","format","_renderRange","_renderScale","invalidateLayoutTree","setVisible","animated","yearPanelWidth","renderContent","select","animate","duration","progress","_onYearPanelWidthChange","complete","_afterYearPanelWidthChange","outerWidth","revalidateLayout","removeContent","updateKeyStrokes","_setProperty","_updateMenuBar","setMenuItems","allowedTypes","onlyVisible","enableDisableKeyStroke","indexOf","setProperty","_adjustHours","optionsMap","values","validHour","hour","_rerenderActivities","ensure","selectDate","setAvailableDisplayModes","_resourcesByIds","_removeSelectedResources","toggleClass","$highlight","cssHeight","outerHeight","$selectorResizeLeft","mousedown","_onResizeMouseDown","$selectorResizeRight","cssWidth","_onRangeSelectorContextMenu","left","cssLeft","_removeSelectedActivity","ids","update","$yearList","_scrollYear","visible","diff","validateLayoutTree","equals","slice","trigger","deselected","removeAll","deselectResources","_removeAllResources","updatedResource","oldResource","Error","replace","$updatedResource","replaceWith"],"mappings":"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","sourcesContent":["/*\n * Copyright (c) 2014-2018 BSI Business Systems Integration AG.\n * All rights reserved. This program and the accompanying materials\n * are made available under the terms of the Eclipse Public License v1.0\n * which accompanies this distribution, and is available at\n * http://www.eclipse.org/legal/epl-v10.html\n *\n * Contributors:\n *     BSI Business Systems Integration AG - initial API and implementation\n */\nimport {\n  arrays,\n  DateFormat,\n  DateRange,\n  dates,\n  defaultValues,\n  graphics,\n  HtmlComponent,\n  KeyStrokeContext,\n  MenuBar,\n  menus as menus_1,\n  objects,\n  PlannerLayout,\n  PlannerMenuItemsOrder,\n  Range,\n  scout,\n  scrollbars,\n  strings,\n  styles,\n  tooltips,\n  TooltipSupport,\n  Widget\n} from '../index';\nimport $ from 'jquery';\n\nexport default class Planner extends Widget {\n\n  constructor() {\n    super();\n\n    this.activityMap = [];\n    this.activitySelectable = false;\n    this.availableDisplayModes = [];\n    this.displayMode = null;\n    this.displayModeOptions = {};\n    this.headerVisible = true;\n    this.label = null;\n    this.resources = [];\n    this.resourceMap = [];\n    this.selectionMode = Planner.SelectionMode.MULTI_RANGE;\n    this.selectionRange = new DateRange();\n    this.selectedResources = [];\n    this.viewRange = {};\n    this.selectedActivity = null;\n\n    // visual\n    this._resourceTitleWidth = 20;\n    this._rangeSelectionStarted = false;\n    this.startRow = null;\n    this.lastRow = null;\n\n    // main elements\n    this.$container = null;\n    this.$range = null;\n    this.$modes = null;\n    this.$grid = null;\n\n    // scale calculator\n    this.transformLeft = function(t) {\n      return t;\n    };\n    this.transformWidth = function(t0, t1) {\n      return (t1 - t0);\n    };\n\n    this.yearPanelVisible = false;\n    this._addWidgetProperties(['menus']);\n  }\n\n  static Direction = {\n    BACKWARD: -1,\n    FORWARD: 1\n  };\n\n  /**\n   * Enum providing display-modes for planner (extends calendar).\n   * @see IPlannerDisplayMode.java\n   */\n  static DisplayMode = {\n    DAY: 1,\n    WEEK: 2,\n    MONTH: 3,\n    WORK_WEEK: 4,\n    CALENDAR_WEEK: 5,\n    YEAR: 6\n  };\n\n  static SelectionMode = {\n    NONE: 0,\n    SINGLE_RANGE: 1,\n    MULTI_RANGE: 2\n  };\n\n  static RANGE_SELECTION_MOVE_THRESHOLD = 10;\n\n  /**\n   * @override\n   */\n  _createKeyStrokeContext() {\n    return new KeyStrokeContext();\n  }\n\n  _init(model) {\n    super._init(model);\n    this._yearPanel = scout.create('YearPanel', {\n      parent: this,\n      alwaysSelectFirstDay: true\n    });\n    this._yearPanel.on('dateSelect', this._onYearPanelDateSelect.bind(this));\n    this._header = scout.create('PlannerHeader', {\n      parent: this\n    });\n    this._header.on('todayClick', this._onTodayClick.bind(this));\n    this._header.on('yearClick', this._onYearClick.bind(this));\n    this._header.on('previousClick', this._onPreviousClick.bind(this));\n    this._header.on('nextClick', this._onNextClick.bind(this));\n    this._header.on('displayModeClick', this._onDisplayModeClick.bind(this));\n    this.menuBar = scout.create('MenuBar', {\n      parent: this,\n      position: MenuBar.Position.BOTTOM,\n      menuOrder: new PlannerMenuItemsOrder(this.session, 'Planner')\n    });\n    for (var i = 0; i < this.resources.length; i++) {\n      this._initResource(this.resources[i]);\n    }\n    this._setDisplayMode(this.displayMode);\n    this._setAvailableDisplayModes(this.availableDisplayModes);\n    this._setViewRange(this.viewRange);\n    this._setSelectedResources(this.selectedResources);\n    this._setSelectedActivity(this.selectedActivity);\n    this._setSelectionRange(this.selectionRange);\n    this._setMenus(this.menus);\n    this._setDisplayModeOptions(this.displayModeOptions);\n\n    this._tooltipSupport = new TooltipSupport({\n      parent: this,\n      arrowPosition: 50\n    });\n  }\n\n  _initResource(resource) {\n    defaultValues.applyTo(resource, 'Resource');\n    resource.activities.forEach(function(activity) {\n      this._initActivity(activity);\n    }, this);\n    this.resourceMap[resource.id] = resource;\n  }\n\n  _initActivity(activity) {\n    activity.beginTime = dates.parseJsonDate(activity.beginTime);\n    activity.endTime = dates.parseJsonDate(activity.endTime);\n    defaultValues.applyTo(activity, 'Activity');\n    this.activityMap[activity.id] = activity;\n  }\n\n  _render() {\n    // basics, layout etc.\n    this.$container = this.$parent.appendDiv('planner');\n    var layout = new PlannerLayout(this);\n    this.htmlComp = HtmlComponent.install(this.$container, this.session);\n    this.htmlComp.setLayout(layout);\n\n    // main elements\n    this._header.render();\n    this._yearPanel.render();\n    this.$grid = this.$container.appendDiv('planner-grid')\n      .on('mousedown', '.resource-cells', this._onCellMouseDown.bind(this))\n      .on('mousedown', '.resource-title', this._onResourceTitleMouseDown.bind(this))\n      .on('contextmenu', '.resource-title', this._onResourceTitleContextMenu.bind(this))\n      .on('contextmenu', '.planner-activity', this._onActivityContextMenu.bind(this));\n    this.$scale = this.$container.appendDiv('planner-scale');\n    this.menuBar.render();\n\n    tooltips.install(this.$grid, {\n      parent: this,\n      selector: '.planner-activity',\n      text: function($comp) {\n        if (this._activityById($comp.attr('data-id'))) {\n          return this._activityById($comp.attr('data-id')).tooltipText;\n        }\n        return undefined;\n\n      }.bind(this)\n    });\n\n    this._installScrollbars();\n    this._gridScrollHandler = this._onGridScroll.bind(this);\n    this.$grid.on('scroll', this._gridScrollHandler);\n  }\n\n  _renderProperties() {\n    super._renderProperties();\n\n    this._renderViewRange();\n    this._renderHeaderVisible();\n    this._renderYearPanelVisible(false);\n    this._renderResources();\n    this._renderSelectedActivity();\n    this._renderSelectedResources();\n    // render with setTimeout because the planner needs to be layouted first\n    setTimeout(this._renderSelectionRange.bind(this));\n  }\n\n  /**\n   * @override\n   */\n  get$Scrollable() {\n    return this.$grid;\n  }\n\n  /* -- basics, events -------------------------------------------- */\n\n  _onPreviousClick(event) {\n    this._navigateDate(Planner.Direction.BACKWARD);\n  }\n\n  _onNextClick(event) {\n    this._navigateDate(Planner.Direction.FORWARD);\n  }\n\n  _navigateDate(direction) {\n    var viewRange = new DateRange(this.viewRange.from, this.viewRange.to),\n      displayMode = Planner.DisplayMode;\n\n    if (this.displayMode === displayMode.DAY) {\n      viewRange.from = dates.shift(this.viewRange.from, 0, 0, direction);\n      viewRange.to = dates.shift(this.viewRange.to, 0, 0, direction);\n    } else if (scout.isOneOf(this.displayMode, displayMode.WEEK, displayMode.WORK_WEEK)) {\n      viewRange.from = dates.shift(this.viewRange.from, 0, 0, direction * 7);\n      viewRange.from = dates.ensureMonday(viewRange.from, -1 * direction);\n      viewRange.to = dates.shift(this.viewRange.to, 0, 0, direction * 7);\n    } else if (this.displayMode === displayMode.MONTH) {\n      viewRange.from = dates.shift(this.viewRange.from, 0, direction, 0);\n      viewRange.from = dates.ensureMonday(viewRange.from, -1 * direction);\n      viewRange.to = dates.shift(this.viewRange.to, 0, direction, 0);\n    } else if (this.displayMode === displayMode.CALENDAR_WEEK) {\n      viewRange.from = dates.shift(this.viewRange.from, 0, direction, 0);\n      viewRange.from = dates.ensureMonday(viewRange.from, -1 * direction);\n      viewRange.to = dates.shift(this.viewRange.to, 0, direction, 0);\n    } else if (this.displayMode === displayMode.YEAR) {\n      viewRange.from = dates.shift(this.viewRange.from, 0, 3 * direction, 0);\n      viewRange.to = dates.shift(this.viewRange.to, 0, 3 * direction, 0);\n    }\n\n    this.setViewRange(viewRange);\n  }\n\n  _onTodayClick(event) {\n    var today = new Date(),\n      year = today.getFullYear(),\n      month = today.getMonth(),\n      date = today.getDate(),\n      day = (today.getDay() + 6) % 7,\n      displayMode = Planner.DisplayMode;\n\n    if (this.displayMode === displayMode.DAY) {\n      today = new Date(year, month, date);\n    } else if (this.displayMode === displayMode.YEAR) {\n      today = new Date(year, month, 1);\n    } else {\n      today = new Date(year, month, date - day);\n    }\n\n    this.setViewRangeFrom(today);\n  }\n\n  _onDisplayModeClick(event) {\n    var displayMode = event.displayMode;\n    this.setDisplayMode(displayMode);\n  }\n\n  _onYearClick(event) {\n    this.setYearPanelVisible(!this.yearPanelVisible);\n  }\n\n  _onYearPanelDateSelect(event) {\n    this.setViewRangeFrom(event.date);\n  }\n\n  _onResourceTitleMouseDown(event) {\n    var $resource = $(event.target).parent();\n    if ($resource.isSelected()) {\n      if (event.which === 3 || event.which === 1 && event.ctrlKey) {\n        // Right click on an already selected resource must not clear the selection -> context menu will be opened\n        return;\n      }\n    }\n    this.startRow = $resource.data('resource');\n    this.lastRow = this.startRow;\n    this._select();\n  }\n\n  _onResourceTitleContextMenu(event) {\n    this._showContextMenu(event, 'Planner.Resource');\n  }\n\n  _onRangeSelectorContextMenu(event) {\n    this._showContextMenu(event, 'Planner.Range');\n  }\n\n  _onActivityContextMenu(event) {\n    this._showContextMenu(event, 'Planner.Activity');\n  }\n\n  _showContextMenu(event, allowedType) {\n    event.preventDefault();\n    event.stopPropagation();\n    var func = function func(event, allowedType) {\n      if (!this.rendered || !this.attached) { // check needed because function is called asynchronously\n        return;\n      }\n      var filteredMenus = this._filterMenus([allowedType], true),\n        $part = $(event.currentTarget);\n      if (filteredMenus.length === 0) {\n        return; // at least one menu item must be visible\n      }\n      var popup = scout.create('ContextMenuPopup', {\n        parent: this,\n        menuItems: filteredMenus,\n        location: {\n          x: event.pageX,\n          y: event.pageY\n        },\n        $anchor: $part\n      });\n      popup.open();\n    }.bind(this);\n\n    this.session.onRequestsDone(func, event, allowedType);\n  }\n\n  _onGridScroll() {\n    this._reconcileScrollPos();\n  }\n\n  _reconcileScrollPos() {\n    // When scrolling horizontally scroll scale as well\n    var scrollLeft = this.$grid.scrollLeft();\n    this.$scale.scrollLeft(scrollLeft);\n  }\n\n  _renderRange() {\n    if (!this.viewRange.from || !this.viewRange.to) {\n      return;\n    }\n    var text,\n      toDate = new Date(this.viewRange.to.valueOf() - 1),\n      toText = this.session.text('ui.to'),\n      displayMode = Planner.DisplayMode;\n\n    // find range text\n    if (dates.isSameDay(this.viewRange.from, toDate)) {\n      text = this._dateFormat(this.viewRange.from, 'd. MMMM yyyy');\n    } else if (this.viewRange.from.getMonth() === toDate.getMonth() && this.viewRange.from.getFullYear() === toDate.getFullYear()) {\n      text = strings.join(' ', this._dateFormat(this.viewRange.from, 'd.'), toText, this._dateFormat(toDate, 'd. MMMM yyyy'));\n    } else if (this.viewRange.from.getFullYear() === toDate.getFullYear()) {\n      if (this.displayMode === displayMode.YEAR) {\n        text = strings.join(' ', this._dateFormat(this.viewRange.from, 'MMMM'), toText, this._dateFormat(toDate, 'MMMM yyyy'));\n      } else {\n        text = strings.join(' ', this._dateFormat(this.viewRange.from, 'd.  MMMM'), toText, this._dateFormat(toDate, 'd. MMMM yyyy'));\n      }\n    } else {\n      if (this.displayMode === displayMode.YEAR) {\n        text = strings.join(' ', this._dateFormat(this.viewRange.from, 'MMMM yyyy'), toText, this._dateFormat(toDate, 'MMMM yyyy'));\n      } else {\n        text = strings.join(' ', this._dateFormat(this.viewRange.from, 'd.  MMMM yyyy'), toText, this._dateFormat(toDate, 'd. MMMM yyyy'));\n      }\n    }\n\n    // set text\n    $('.planner-select', this._header.$range).text(text);\n  }\n\n  _renderScale() {\n    if (!this.viewRange.from || !this.viewRange.to) {\n      return;\n    }\n    var width,\n      that = this,\n      displayMode = Planner.DisplayMode;\n\n    // empty scale\n    this.$scale.empty();\n    this.$grid.children('.planner-small-scale-item-line').remove();\n    this.$grid.children('.planner-large-scale-item-line').remove();\n\n    // append main elements\n    this.$scaleTitle = this.$scale.appendDiv('planner-scale-title');\n    this._renderLabel();\n    this.$timeline = this.$scale.appendDiv('timeline');\n    this.$timelineLarge = this.$timeline.appendDiv('timeline-large');\n    this.$timelineSmall = this.$timeline.appendDiv('timeline-small');\n\n    // fill timeline large depending on mode\n    if (this.displayMode === displayMode.DAY) {\n      this._renderDayScale();\n    } else if (scout.isOneOf(this.displayMode, displayMode.WORK_WEEK, displayMode.WEEK)) {\n      this._renderWeekScale();\n    } else if (this.displayMode === displayMode.MONTH) {\n      this._renderMonthScale();\n    } else if (this.displayMode === displayMode.CALENDAR_WEEK) {\n      this._renderCalendarWeekScale();\n    } else if (this.displayMode === displayMode.YEAR) {\n      this._renderYearScale();\n    }\n\n    // set sizes and append scale lines\n    var $smallScaleItems = this.$timelineSmall.children('.scale-item');\n    var $largeScaleItems = this.$timelineLarge.children('.scale-item');\n    width = 100 / $smallScaleItems.length;\n    $largeScaleItems.each(function() {\n      var $scaleItem = $(this);\n      var $largeGridLine = that.$grid.prependDiv('planner-large-scale-item-line');\n      $scaleItem.css('width', $scaleItem.data('count') * width + '%')\n        .data('scale-item-line', $largeGridLine);\n      $scaleItem.prependDiv('planner-large-scale-item-line')\n        .css('left', 0);\n    });\n    $smallScaleItems.each(function(index) {\n      var $scaleItem = $(this);\n      $scaleItem.css('width', width + '%');\n      if (!$scaleItem.data('first')) {\n        var $smallGridLine = that.$grid.prependDiv('planner-small-scale-item-line');\n        $scaleItem.data('scale-item-line', $smallGridLine);\n        $scaleItem.prependDiv('planner-small-scale-item-line')\n          .css('left', 0);\n      }\n    });\n\n    // find transfer function\n    this.beginScale = this.$timelineSmall.children().first().data('date-from').valueOf();\n    this.endScale = this.$timelineSmall.children().last().data('date-to').valueOf();\n\n    if (scout.isOneOf(this.displayMode, displayMode.WORK_WEEK, displayMode.WEEK)) {\n      var options = this.displayModeOptions[this.displayMode];\n      var interval = options.interval;\n      var firstHourOfDay = options.firstHourOfDay;\n      var lastHourOfDay = options.lastHourOfDay;\n\n      this.transformLeft = function(begin, end, firstHour, lastHour, interval) {\n        return function(t) {\n          t = new Date(t);\n          begin = new Date(begin);\n          end = new Date(end);\n          var fullRangeMillis = end - begin;\n          // remove day component from range for scaling\n          var dayDiffTBegin = dates.compareDays(t, begin);\n          var dayDIffEndBegin = dates.compareDays(end, begin);\n          var dayComponentMillis = dayDiffTBegin * 3600000 * 24;\n          var rangeScaling = (24 / (lastHour - firstHour + 1));\n          // re-add day component\n          var dayOffset = dayDiffTBegin / dayDIffEndBegin;\n\n          if (t.getHours() < firstHour) {\n            // If t is in the morning before the first hour of day, return 00:00 of this day\n            return (rangeScaling / fullRangeMillis + dayOffset) * 100;\n          }\n          if (t.getHours() > lastHour) {\n            // If t is in the evening after the last hour of day, return 00:00 of next day\n            dayOffset = (dayDiffTBegin + 1) / dayDIffEndBegin;\n            return (rangeScaling / fullRangeMillis + dayOffset) * 100;\n          }\n\n          return ((t.valueOf() - (begin.valueOf() + firstHour * 3600000) - dayComponentMillis) * rangeScaling / fullRangeMillis + dayOffset) * 100;\n        };\n      }(this.viewRange.from, this.viewRange.to, firstHourOfDay, lastHourOfDay, interval);\n\n      this.transformWidth = function(begin, end, firstHour, lastHour, interval) {\n        return function(t0, t1) {\n          var fullRangeMillis = end - begin;\n          var selectionRange = new Range(new Date(t0), new Date(t1));\n          var hiddenRanges = this._findHiddenRangesInWeekMode();\n          var selectedRangeMillis = selectionRange.subtractAll(hiddenRanges).reduce(function(acc, range) {\n            return acc + range.size();\n          }, 0);\n          var rangeScaling = (24 / (lastHour - firstHour + 1));\n          return (selectedRangeMillis * rangeScaling) / fullRangeMillis * 100;\n        };\n      }(this.viewRange.from, this.viewRange.to, firstHourOfDay, lastHourOfDay, interval);\n    } else {\n      this.transformLeft = function(begin, end) {\n        return function(t) {\n          return (t - begin) / (end - begin) * 100;\n        };\n      }(this.beginScale, this.endScale);\n\n      this.transformWidth = function(begin, end) {\n        return function(t0, t1) {\n          return (t1 - t0) / (end - begin) * 100;\n        };\n      }(this.beginScale, this.endScale);\n    }\n  }\n\n  /**\n   * Returns every hidden range of the view range created by first and last our of day.\n   */\n  _findHiddenRangesInWeekMode() {\n    if (!scout.isOneOf(this.displayMode, Planner.DisplayMode.WORK_WEEK, Planner.DisplayMode.WEEK)) {\n      return [];\n    }\n    var ranges = [];\n    var options = this.displayModeOptions[this.displayMode];\n    var firstHourOfDay = options.firstHourOfDay;\n    var lastHourOfDay = options.lastHourOfDay;\n    var currentDate = new Date(this.viewRange.from.valueOf());\n    var hiddenRange;\n    while (currentDate < this.viewRange.to) {\n      // Start of day range\n      hiddenRange = new Range(new Date(currentDate.valueOf()), dates.shiftTime(currentDate, firstHourOfDay));\n      if (hiddenRange.size() > 0) {\n        ranges.push(hiddenRange);\n      }\n      // End of day range\n      hiddenRange = new Range(dates.shiftTime(currentDate, lastHourOfDay + 1), dates.shiftTime(currentDate, 24));\n      if (hiddenRange.size() > 0) {\n        ranges.push(hiddenRange);\n      }\n      currentDate.setHours(0);\n      currentDate.setMinutes(0);\n      currentDate.setDate(currentDate.getDate() + 1);\n    }\n    return ranges;\n  }\n\n  _renderDayScale() {\n    var newLargeGroup, $divLarge, $divSmall,\n      first = true;\n    var loop = new Date(this.viewRange.from.valueOf());\n    var options = this.displayModeOptions[this.displayMode];\n    var interval = options.interval;\n    var labelPeriod = options.labelPeriod;\n    var firstHourOfDay = options.firstHourOfDay;\n    var lastHourOfDay = options.lastHourOfDay;\n\n    // cap interval to day range\n    interval = Math.min(interval, 60 * (lastHourOfDay - firstHourOfDay + 1));\n\n    // from start to end\n    while (loop < this.viewRange.to) {\n      if (loop.getHours() >= firstHourOfDay && loop.getHours() <= lastHourOfDay) {\n        newLargeGroup = false;\n        if (loop.getMinutes() === 0 || first) {\n          $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'HH')).data('count', 0);\n          newLargeGroup = true;\n        }\n\n        $divSmall = this.$timelineSmall\n          .appendDiv('scale-item', this._dateFormat(loop, ':mm'))\n          .data('date-from', new Date(loop.valueOf()));\n\n        // hide label\n        if ((loop.getMinutes() % (interval * labelPeriod)) !== 0) {\n          $divSmall.addClass('label-invisible');\n        }\n\n        // increase variables\n        loop = dates.shiftTime(loop, 0, interval, 0);\n        this._incrementTimelineScaleItems($divLarge, $divSmall, loop, newLargeGroup);\n        first = false;\n      } else {\n        loop = dates.shiftTime(loop, 0, interval, 0);\n      }\n    }\n  }\n\n  _renderWeekScale() {\n    var newLargeGroup, $divLarge, $divSmall,\n      first = true;\n    var loop = new Date(this.viewRange.from.valueOf());\n\n    var options = this.displayModeOptions[this.displayMode];\n    var interval = options.interval;\n    var labelPeriod = options.labelPeriod;\n    var firstHourOfDay = options.firstHourOfDay;\n    var lastHourOfDay = options.lastHourOfDay;\n\n    // cap interval to day range\n    interval = Math.min(interval, 60 * (lastHourOfDay - firstHourOfDay + 1));\n\n    // from start to end\n    while (loop < this.viewRange.to) {\n      newLargeGroup = false;\n      if (loop.getHours() < firstHourOfDay) {\n        loop.setHours(firstHourOfDay);\n      }\n\n      if (loop.getHours() === firstHourOfDay && loop.getMinutes() === 0 || first) {\n        if (loop.getMonth() === 0 || first) {\n          $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'd. MMMM yyyy')).data('count', 0);\n        } else if (loop.getDate() === 1) {\n          $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'd. MMMM')).data('count', 0);\n        } else {\n          $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'd.')).data('count', 0);\n        }\n        newLargeGroup = true;\n      }\n\n      $divSmall = this.$timelineSmall\n        .appendDiv('scale-item', this._dateFormat(loop, 'HH:mm'))\n        .data('date-from', new Date(loop.valueOf()));\n\n      // hide label\n      if (((loop.getHours() - firstHourOfDay) * 60 + loop.getMinutes()) % (interval * labelPeriod) !== 0) {\n        $divSmall.addClass('label-invisible');\n      }\n\n      // increase variables\n      loop = dates.shiftTime(loop, 0, interval, 0, 0);\n      this._incrementTimelineScaleItems($divLarge, $divSmall, loop, newLargeGroup);\n      first = false;\n\n      if (loop.getHours() > lastHourOfDay) {\n        // jump to next day\n        loop.setHours(0);\n        loop.setMinutes(0);\n        loop.setDate(loop.getDate() + 1);\n      }\n    }\n  }\n\n  _renderMonthScale() {\n    var newLargeGroup, $divLarge, $divSmall,\n      first = true;\n    var loop = new Date(this.viewRange.from.valueOf());\n\n    var options = this.displayModeOptions[this.displayMode];\n    var labelPeriod = options.labelPeriod;\n\n    // from start to end\n    while (loop < this.viewRange.to) {\n      newLargeGroup = false;\n      if (loop.getDate() === 1 || first) {\n        if (loop.getMonth() === 0 || first) {\n          $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'MMMM yyyy')).data('count', 0);\n        } else {\n          $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'MMMM')).data('count', 0);\n        }\n        newLargeGroup = true;\n      }\n\n      $divSmall = this.$timelineSmall\n        .appendDiv('scale-item', this._dateFormat(loop, 'dd'))\n        .data('date-from', new Date(loop.valueOf()));\n\n      // hide label\n      if (loop.getDate() % labelPeriod !== 0) {\n        $divSmall.addClass('label-invisible');\n      }\n\n      loop = dates.shift(loop, 0, 0, 1);\n      this._incrementTimelineScaleItems($divLarge, $divSmall, loop, newLargeGroup);\n      first = false;\n    }\n  }\n\n  _renderCalendarWeekScale() {\n    var newLargeGroup, $divLarge, $divSmall,\n      first = true;\n    var loop = new Date(this.viewRange.from.valueOf());\n\n    var options = this.displayModeOptions[this.displayMode];\n    var labelPeriod = options.labelPeriod;\n\n    // from start to end\n    while (loop < this.viewRange.to) {\n      newLargeGroup = false;\n      if (loop.getDate() < 8 || first === true) {\n        if (loop.getMonth() === 0 || first === true) {\n          if (loop.getDate() > 11) {\n            $divLarge = this.$timelineLarge.appendDiv('scale-item').html('&nbsp;').data('count', 0);\n            first = 2;\n          } else {\n            $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'MMMM yyyy')).data('count', 0);\n            first = false;\n          }\n        } else {\n          if (first === 2) {\n            $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'MMMM yyyy')).data('count', 0);\n            first = false;\n          } else {\n            $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'MMMM')).data('count', 0);\n          }\n        }\n        newLargeGroup = true;\n      }\n\n      $divSmall = this.$timelineSmall\n        .appendDiv('scale-item', dates.weekInYear(loop))\n        .data('date-from', new Date(loop.valueOf()))\n        .data('tooltipText', this._scaleTooltipText.bind(this));\n      this._tooltipSupport.install($divSmall);\n\n      // hide label\n      if (dates.weekInYear(loop) % labelPeriod !== 0) {\n        $divSmall.addClass('label-invisible');\n      }\n\n      loop.setDate(loop.getDate() + 7);\n      this._incrementTimelineScaleItems($divLarge, $divSmall, loop, newLargeGroup);\n    }\n  }\n\n  _renderYearScale() {\n    var newLargeGroup, $divLarge, $divSmall,\n      first = true;\n    var loop = new Date(this.viewRange.from.valueOf());\n    var options = this.displayModeOptions[this.displayMode];\n    var labelPeriod = options.labelPeriod;\n\n    // from start to end\n    while (loop < this.viewRange.to) {\n      newLargeGroup = false;\n      if (loop.getMonth() === 0 || first) {\n        $divLarge = this.$timelineLarge.appendDiv('scale-item', this._dateFormat(loop, 'yyyy')).data('count', 0);\n        newLargeGroup = true;\n      }\n\n      $divSmall = this.$timelineSmall\n        .appendDiv('scale-item', this._dateFormat(loop, 'MMMM'))\n        .data('date-from', new Date(loop.valueOf()));\n\n      // hide label\n      if (loop.getMonth() % labelPeriod !== 0) {\n        $divSmall.addClass('label-invisible');\n      }\n\n      loop = dates.shift(loop, 0, 1, 0);\n      this._incrementTimelineScaleItems($divLarge, $divSmall, loop, newLargeGroup);\n      first = false;\n    }\n  }\n\n  /**\n   * @param {Date} newDate\n   */\n  _incrementTimelineScaleItems($largeComp, $smallComp, newDate, newLargeGroup) {\n    $largeComp.data('count', $largeComp.data('count') + 1);\n    $smallComp.data('date-to', new Date(newDate.valueOf()))\n      .data('first', newLargeGroup);\n  }\n\n  /* -- scale events --------------------------------------------------- */\n\n  _scaleTooltipText($scale) {\n    var toText = ' ' + this.session.text('ui.to') + ' ',\n      from = new Date($scale.data('date-from').valueOf()),\n      to = new Date($scale.data('date-to').valueOf() - 1);\n\n    if (from.getMonth() === to.getMonth()) {\n      return this._dateFormat(from, 'd.') + toText + this._dateFormat(to, 'd. MMMM yyyy');\n    } else if (from.getFullYear() === to.getFullYear()) {\n      return this._dateFormat(from, 'd. MMMM') + toText + this._dateFormat(to, 'd. MMMM yyyy');\n    }\n    return this._dateFormat(from, 'd. MMMM yyyy') + toText + this._dateFormat(to, 'd. MMMM yyyy');\n  }\n\n  /* --  render resources, activities --------------------------------- */\n\n  _removeAllResources() {\n    this.resources.forEach(function(resource) {\n      resource.$resource.remove();\n    });\n  }\n\n  _renderResources(resources) {\n    var i, resource,\n      resourcesHtml = '';\n\n    resources = resources || this.resources;\n    for (i = 0; i < resources.length; i++) {\n      resource = resources[i];\n      resourcesHtml += this._buildResourceHtml(resource, this.$grid);\n    }\n\n    // Append resources to grid\n    $(resourcesHtml).appendTo(this.$grid);\n\n    // Match resources\n    this.$grid.children('.planner-resource').each(function(index, element) {\n      var $element = $(element);\n      resource = this._resourceById($element.attr('data-id'));\n      this._linkResource($element, resource);\n      this._linkActivitiesForResource(resource);\n    }.bind(this));\n  }\n\n  _linkResource($resource, resource) {\n    $resource.data('resource', resource);\n    resource.$resource = $resource;\n    resource.$cells = $resource.children('.resource-cells');\n  }\n\n  _linkActivity($activity, activity) {\n    $activity.data('activity', activity);\n    activity.$activity = $activity;\n  }\n\n  _rerenderActivities(resources) {\n    resources = resources || this.resources;\n    resources.forEach(function(resource) {\n      this._removeActivitiesForResource(resource);\n      this._renderActivititesForResource(resource);\n    }, this);\n  }\n\n  _buildResourceHtml(resource) {\n    var resourceHtml = '<div class=\"planner-resource\" data-id=\"' + resource.id + '\">';\n    resourceHtml += '<div class=\"resource-title\">' + strings.encode(resource.resourceCell.text || '') + '</div>';\n    resourceHtml += '<div class=\"resource-cells\">' + this._buildActivitiesHtml(resource) + '</div>';\n    resourceHtml += '</div>';\n    return resourceHtml;\n  }\n\n  _renderActivititesForResource(resource) {\n    resource.$cells.html(this._buildActivitiesHtml(resource));\n    this._linkActivitiesForResource(resource);\n  }\n\n  _linkActivitiesForResource(resource) {\n    resource.$cells.children('.planner-activity').each(function(index, element) {\n      var $element = $(element);\n      var activity = this._activityById($element.attr('data-id'));\n      this._linkActivity($element, activity);\n    }.bind(this));\n  }\n\n  _buildActivitiesHtml(resource) {\n    var activitiesHtml = '';\n    resource.activities.forEach(function(activity) {\n      if (activity.beginTime.valueOf() >= this.endScale ||\n        activity.endTime.valueOf() <= this.beginScale) {\n        // don't add activities which are not in the view range\n        return;\n      }\n      activitiesHtml += this._buildActivityHtml(activity);\n    }, this);\n    return activitiesHtml;\n  }\n\n  _removeActivitiesForResource(resource) {\n    resource.activities.forEach(function(activity) {\n      if (activity.$activity) {\n        activity.$activity.remove();\n        activity.$activity = null;\n      }\n    }, this);\n  }\n\n  _buildActivityHtml(activity) {\n    var level = 100 - Math.min(activity.level * 100, 100),\n      backgroundColor = styles.modelToCssColor(activity.backgroundColor),\n      foregroundColor = styles.modelToCssColor(activity.foregroundColor),\n      levelColor = styles.modelToCssColor(activity.levelColor),\n      begin = activity.beginTime.valueOf(),\n      end = activity.endTime.valueOf();\n\n    // Make sure activity fits into scale\n    begin = Math.max(begin, this.beginScale);\n    end = Math.min(end, this.endScale);\n\n    var activityCssClass = 'planner-activity' + (activity.cssClass ? (' ' + activity.cssClass) : '');\n    var activityStyle = 'left: ' + 'calc(' + this.transformLeft(begin) + '% + 2px);';\n    activityStyle += ' width: ' + 'calc(' + this.transformWidth(begin, end) + '% - 4px);';\n\n    if (levelColor) {\n      activityStyle += ' background-color: ' + levelColor + ';';\n      activityStyle += ' border-color: ' + levelColor + ';';\n    }\n    if (!levelColor && backgroundColor) {\n      activityStyle += ' background-color: ' + backgroundColor + ';';\n      activityStyle += ' border-color: ' + backgroundColor + ';';\n    }\n    if (foregroundColor) {\n      activityStyle += ' color: ' + foregroundColor + ';';\n    }\n\n    // The background-color represents the fill level and not the image. This makes it easier to change the color using a css class\n    // In order to change the background rather than the fill, use the planner-activity-level css class\n    var activityLevelCssClass = 'planner-activity-level' + (activity.cssClass ? (' ' + activity.cssClass) : '');\n    var activityEmptyColor = styles.get(activityLevelCssClass, 'background-color').backgroundColor;\n    activityStyle += ' background-image: ' + 'linear-gradient(to bottom, ' + activityEmptyColor + ' 0%, ' + activityEmptyColor + ' ' + level + '%, transparent ' + level + '%, transparent 100% );';\n\n    var activityHtml = '<div';\n    activityHtml += ' class=\"' + activityCssClass + '\"';\n    activityHtml += ' style=\"' + activityStyle + '\"';\n    activityHtml += ' data-id=\"' + activity.id + '\"';\n    activityHtml += '>' + strings.encode(activity.text || '') + '</div>';\n    return activityHtml;\n  }\n\n  /* -- selector -------------------------------------------------- */\n\n  _onCellMouseDown(event) {\n    var $activity,\n      $resource,\n      $target = $(event.target),\n      selectionMode = Planner.SelectionMode,\n      opensContextMenu = (event.which === 3 || event.which === 1 && event.ctrlKey);\n\n    if (this.activitySelectable) {\n      if (!opensContextMenu && this.$selector) {\n        // Hide selector otherwise activity may not be resolved (elementFromPoint would return the $selector)\n        // This allows selecting an activity which is inside a selection range\n        this.$selector.hide();\n      }\n      $activity = this.$grid.elementFromPoint(event.pageX, event.pageY);\n      if (!opensContextMenu && this.$selector) {\n        this.$selector.show();\n      }\n      if ($activity.hasClass('planner-activity')) {\n        $resource = $activity.parent().parent();\n        this.selectResources([$resource.data('resource')]);\n        this.selectActivity($activity.data('activity'));\n        this.selectRange(new DateRange());\n      } else {\n        this.selectActivity(null);\n      }\n    } else {\n      this.selectActivity(null);\n    }\n\n    if (this.selectionMode === selectionMode.NONE) {\n      return;\n    }\n\n    if ($target.hasClass('selector') && opensContextMenu) {\n      // Right click on the selector must not clear the selection -> context menu will be opened\n      return;\n    }\n\n    if (!this.selectedActivity) {\n      // If not an activity was selected, start immediately, otherwise start as soon the mouse moves\n      this._startRangeSelection(event.pageX, event.pageY);\n    }\n\n    // add event handlers\n    this._cellMousemoveHandler = this._onCellMousemove.bind(this, event);\n    $target.document()\n      .on('mousemove', this._cellMousemoveHandler)\n      .one('mouseup', this._onDocumentMouseUp.bind(this));\n  }\n\n  _startRangeSelection(pageX, pageY) {\n    // init selector\n    this.startRow = this._findRow(pageY);\n    this.lastRow = this.startRow;\n\n    // find range on scale\n    this.startRange = this._findScale(pageX);\n    this.lastRange = this.startRange;\n\n    // draw\n    this._select(true);\n    this._rangeSelectionStarted = true;\n  }\n\n  /**\n   * @returns {boolean} true if the range selection may be started, false if not\n   */\n  _prepareRangeSelectionByMousemove(mousedownEvent, mousemoveEvent) {\n    var moveX = mousedownEvent.pageX - mousemoveEvent.pageX;\n    var moveY = mousedownEvent.pageY - mousemoveEvent.pageY;\n    var moveThreshold = Planner.RANGE_SELECTION_MOVE_THRESHOLD;\n    if (Math.abs(moveX) >= moveThreshold) {\n      // Accept if x movement is big enough\n      return true;\n    }\n    var mousedownRow = this._findRow(mousedownEvent.pageY);\n    var mousemoveRow = this._findRow(mousemoveEvent.pageY);\n    // Accept if y movement is big enough AND the row changed. No need to switch into range selection mode if cursor is still on the same row\n    return Math.abs(moveY) >= moveThreshold && this.selectionMode === Planner.SelectionMode.MULTI_RANGE && mousedownRow !== mousemoveRow;\n  }\n\n  _onCellMousemove(mousedownEvent, event) {\n    if (this.selectedActivity && !this._rangeSelectionStarted) {\n      // If an activity was selected, switch to range selection if the user moves the mouse\n      if (!this._prepareRangeSelectionByMousemove(mousedownEvent, event)) {\n        return;\n      }\n      this._startRangeSelection(mousedownEvent.pageX, mousedownEvent.pageY);\n    }\n\n    var lastRow = this._findRow(event.pageY);\n    if (lastRow) {\n      this.lastRow = lastRow;\n    }\n    var lastRange = this._findScale(event.pageX);\n    if (lastRange) {\n      this.lastRange = lastRange;\n    }\n\n    this._select(true);\n  }\n\n  _onResizeMouseDown(event) {\n    var swap,\n      $target = $(event.target);\n\n    this.startRow = this.selectedResources[0];\n    this.lastRow = this.selectedResources[this.selectedResources.length - 1];\n\n    // Get the start and last range based on the clicked resize handle. If the ranges cannot be determined it likely means that the selectionRange is out of the current viewRange or dayRange (set by firstHourOfDay, lastHourOfDay)\n    this.startRange = scout.nvl(this._findScaleByFromDate(this.selectionRange.from), new Range(this.selectionRange.from.getTime(), this.selectionRange.from.getTime()));\n    this.lastRange = scout.nvl(this._findScaleByToDate(this.selectionRange.to), new Range(this.selectionRange.to.getTime(), this.selectionRange.to.getTime()));\n\n    // Swap start and last range if resize-left is clicked\n    if ($target.hasClass('selector-resize-left')) {\n      swap = this.startRange;\n      this.startRange = this.lastRange;\n      this.lastRange = swap;\n    }\n\n    $target.body().addClass('col-resize');\n\n    this._resizeMousemoveHandler = this._onResizeMousemove.bind(this);\n    $target.document()\n      .on('mousemove', this._resizeMousemoveHandler)\n      .one('mouseup', this._onDocumentMouseUp.bind(this));\n\n    return false;\n  }\n\n  _onResizeMousemove(event) {\n    if (!this.rendered) {\n      // planner may be removed in the meantime\n      return;\n    }\n    var lastRange = this._findScale(event.pageX);\n    if (lastRange) {\n      this.lastRange = lastRange;\n    }\n    this._select(true);\n  }\n\n  _onDocumentMouseUp(event) {\n    var $target = $(event.target);\n    $target.body().removeClass('col-resize');\n    if (this._cellMousemoveHandler) {\n      $target.document().off('mousemove', this._documentMousemoveHandler);\n      this._cellMousemoveHandler = null;\n    }\n    if (this._resizeMousemoveHandler) {\n      $target.document().off('mousemove', this._resizeMousemoveHandler);\n      this._resizeMousemoveHandler = null;\n    }\n    if (!this._rangeSelectionStarted) {\n      // Range selection has not been initiated -> don't call select()\n      return;\n    }\n    this._rangeSelectionStarted = false;\n    if (this.rendered) {\n      this._select();\n    }\n  }\n\n  _select(whileSelecting) {\n    if (!this.startRow || !this.lastRow) {\n      return;\n    }\n    var rangeSelected = !!(this.startRange && this.lastRange);\n    var $startRow = this.startRow.$resource,\n      $lastRow = this.lastRow.$resource;\n\n    // in case of single selection\n    if (this.selectionMode === Planner.SelectionMode.SINGLE_RANGE) {\n      this.lastRow = this.startRow;\n      $lastRow = this.startRow.$resource;\n    }\n\n    // select rows\n    var $upperRow = ($startRow[0].offsetTop <= $lastRow[0].offsetTop) ? $startRow : $lastRow,\n      $lowerRow = ($startRow[0].offsetTop > $lastRow[0].offsetTop) ? $startRow : $lastRow,\n      resources = $('.planner-resource', this.$grid).toArray(),\n      top = $upperRow[0].offsetTop,\n      low = $lowerRow[0].offsetTop;\n\n    for (var r = resources.length - 1; r >= 0; r--) {\n      var row = resources[r];\n      if ((row.offsetTop < top && row.offsetTop < low) || (row.offsetTop > top && row.offsetTop > low)) {\n        resources.splice(r, 1);\n      }\n    }\n\n    this.selectResources(resources.map(function(i) {\n      return $(i).data('resource');\n    }), !whileSelecting);\n    this.selectActivity(null);\n\n    if (rangeSelected) {\n      // left and width\n      var from = Math.min(this.lastRange.from, this.startRange.from),\n        to = Math.max(this.lastRange.to, this.startRange.to);\n\n      var selectionRange = new DateRange(new Date(from), new Date(to));\n      selectionRange = this._adjustSelectionRange(selectionRange);\n      this.selectRange(selectionRange, !whileSelecting);\n    }\n  }\n\n  _adjustSelectionRange(range) {\n    var from = range.from.getTime();\n    var to = range.to.getTime();\n\n    // Ensure minimum size of selection range (interval is in minutes)\n    var minSelectionDuration = 0;\n    var options = this.displayModeOptions[this.displayMode];\n    if (options.interval > 0 && options.minSelectionIntervalCount > 0) {\n      minSelectionDuration = options.minSelectionIntervalCount * options.interval * 60000;\n    }\n    var lastHourOfDay = options.lastHourOfDay;\n    var endOfDay = dates.shiftTime(dates.trunc(range.from), lastHourOfDay + 1);\n    var viewRange = this._visibleViewRange();\n    if (this.lastRange.from < this.startRange.from) {\n      // Selecting to left\n      if (to - minSelectionDuration >= viewRange.from.getTime()) {\n        // extend to left side\n        from = Math.min(from, to - minSelectionDuration);\n      } else {\n        // extend to right side if from would be smaller than the minimum date (left border)\n        from = viewRange.from.getTime();\n        to = Math.max(to, Math.min(from + minSelectionDuration, viewRange.to.getTime()));\n      }\n    } else {\n      // Selecting to right\n      if (from + minSelectionDuration <= viewRange.to.getTime()) {\n        // extend to right side\n        to = Math.max(to, Math.max(from + minSelectionDuration, viewRange.from.getTime()));\n        if (to >= endOfDay.getTime() && new Range(from, to).size() === minSelectionDuration) {\n          // extend to left side when clicking at the end of a day\n          to = endOfDay.getTime();\n          from = Math.min(from, to - minSelectionDuration);\n        }\n      } else {\n        // extend to left side if to would be greater than the maximum date (right border)\n        to = viewRange.to.getTime();\n        from = Math.min(from, to - minSelectionDuration);\n      }\n    }\n    return new DateRange(new Date(from), new Date(to));\n  }\n\n  _findRow(y) {\n    var $row,\n      gridBounds = graphics.offsetBounds(this.$grid),\n      x = gridBounds.x + 10;\n\n    y = Math.min(Math.max(y, 0), gridBounds.y + gridBounds.height - 1);\n    $row = this.$container.elementFromPoint(x, y, '.planner-resource');\n    if ($row.length > 0) {\n      return $row.data('resource');\n    }\n    return null;\n  }\n\n  _findScale(x) {\n    var $scaleItem,\n      gridBounds = graphics.offsetBounds(this.$grid),\n      y = this.$scale.offset().top + this.$scale.height() * 0.75;\n\n    x = Math.min(Math.max(x, 0), gridBounds.x + gridBounds.width - 1);\n    $scaleItem = this.$container.elementFromPoint(x, y, '.scale-item');\n    if ($scaleItem.length > 0) {\n      return new DateRange($scaleItem.data('date-from').valueOf(), $scaleItem.data('date-to').valueOf());\n    }\n    return null;\n  }\n\n  _findScaleByFromDate(from) {\n    return this._findScaleByFunction(function(i, elem) {\n      var $scaleItem = $(elem);\n      if ($scaleItem.data('date-from').getTime() === from.getTime()) {\n        return true;\n      }\n    });\n  }\n\n  _findScaleByToDate(to) {\n    return this._findScaleByFunction(function(i, elem) {\n      var $scaleItem = $(elem);\n      if ($scaleItem.data('date-to').getTime() === to.getTime()) {\n        return true;\n      }\n    });\n  }\n\n  _findScaleByFunction(func) {\n    var $scaleItem = this.$timelineSmall.children('.scale-item').filter(func);\n    if (!$scaleItem.length) {\n      return null;\n    }\n    return new DateRange($scaleItem.data('date-from').valueOf(), $scaleItem.data('date-to').valueOf());\n  }\n\n  /**\n   * @returns {Range} the visible view range (the difference to this.viewRange is that first and last hourOfDay are considered).\n   */\n  _visibleViewRange() {\n    var $items = this.$timelineSmall.children('.scale-item');\n    return new Range($items.first().data('date-from'), $items.last().data('date-to'));\n  }\n\n  /* -- helper ---------------------------------------------------- */\n\n  /**\n   * @param {Date} date\n   */\n  _dateFormat(date, pattern) {\n    var d = new Date(date.valueOf()),\n      dateFormat = new DateFormat(this.session.locale, pattern);\n\n    return dateFormat.format(d);\n  }\n\n  _renderViewRange() {\n    this._renderRange();\n    this._renderScale();\n    this.invalidateLayoutTree();\n  }\n\n  _renderHeaderVisible() {\n    this._header.setVisible(this.headerVisible);\n    this.invalidateLayoutTree();\n  }\n\n  _renderYearPanelVisible(animated) {\n    var yearPanelWidth;\n    if (this.yearPanelVisible) {\n      this._yearPanel.renderContent();\n    }\n\n    // show or hide year panel\n    $('.calendar-toggle-year', this.$modes).select(this.yearPanelVisible);\n    if (this.yearPanelVisible) {\n      yearPanelWidth = 210;\n    } else {\n      yearPanelWidth = 0;\n    }\n    this._yearPanel.$container.animate({\n      width: yearPanelWidth\n    }, {\n      duration: animated ? 500 : 0,\n      progress: this._onYearPanelWidthChange.bind(this),\n      complete: this._afterYearPanelWidthChange.bind(this)\n    });\n  }\n\n  _onYearPanelWidthChange() {\n    if (!this._yearPanel.$container) {\n      // If container has been removed in the meantime (e.g. user navigates away while animation is in progress)\n      return;\n    }\n    var yearPanelWidth = this._yearPanel.$container.outerWidth();\n    this.$grid.css('width', 'calc(100% - ' + yearPanelWidth + 'px)');\n    this.$scale.css('width', 'calc(100% - ' + yearPanelWidth + 'px)');\n    this.revalidateLayout();\n  }\n\n  _afterYearPanelWidthChange() {\n    if (!this.yearPanelVisible) {\n      this._yearPanel.removeContent();\n    }\n  }\n\n  _setMenus(menus) {\n    this.updateKeyStrokes(menus, this.menus);\n    this._setProperty('menus', menus);\n    this._updateMenuBar();\n  }\n\n  _updateMenuBar() {\n    var menuItems = this._filterMenus(['Planner.EmptySpace', 'Planner.Resource', 'Planner.Activity', 'Planner.Range'], false, true);\n    this.menuBar.setMenuItems(menuItems);\n  }\n\n  _removeMenus() {\n    // menubar takes care about removal\n  }\n\n  _filterMenus(allowedTypes, onlyVisible, enableDisableKeyStroke) {\n    allowedTypes = allowedTypes || [];\n    if (allowedTypes.indexOf('Planner.Resource') > -1 && this.selectedResources.length === 0) {\n      arrays.remove(allowedTypes, 'Planner.Resource');\n    }\n    if (allowedTypes.indexOf('Planner.Activity') > -1 && !this.selectedActivity) {\n      arrays.remove(allowedTypes, 'Planner.Activity');\n    }\n    if (allowedTypes.indexOf('Planner.Range') > -1 && !this.selectionRange.from && !this.selectionRange.to) {\n      arrays.remove(allowedTypes, 'Planner.Range');\n    }\n    return menus_1.filter(this.menus, allowedTypes, onlyVisible, enableDisableKeyStroke);\n  }\n\n  setDisplayModeOptions(displayModeOptions) {\n    this.setProperty('displayModeOptions', displayModeOptions);\n  }\n\n  _setDisplayModeOptions(displayModeOptions) {\n    if (displayModeOptions) {\n      this._adjustHours(displayModeOptions);\n    }\n    this.displayModeOptions = displayModeOptions;\n  }\n\n  /**\n   * Make sure configured our is between 0 and 23.\n   */\n  _adjustHours(optionsMap) {\n    objects.values(optionsMap).forEach(function(options) {\n      if (options.firstHourOfDay) {\n        options.firstHourOfDay = validHour(options.firstHourOfDay);\n      }\n      if (options.lastHourOfDay) {\n        options.lastHourOfDay = validHour(options.lastHourOfDay);\n      }\n    });\n\n    function validHour(hour) {\n      if (hour < 0) {\n        return 0;\n      }\n      if (hour > 23) {\n        return 23;\n      }\n      return hour;\n    }\n  }\n\n  _renderDisplayModeOptions() {\n    this._renderRange();\n    this._renderScale();\n    this._rerenderActivities(); // required in case first/lastHourOfDay changes\n    this._select(); // adjust selection if minSelectionIntervalCount has changed\n    this.invalidateLayoutTree();\n  }\n\n  _renderAvailableDisplayModes() {\n    // done by PlannerHeader.js\n  }\n\n  _renderDisplayMode() {\n    // done by PlannerHeader.js\n  }\n\n  _setViewRange(viewRange) {\n    viewRange = DateRange.ensure(viewRange);\n    this._setProperty('viewRange', viewRange);\n    this._yearPanel.setViewRange(this.viewRange);\n    this._yearPanel.selectDate(this.viewRange.from);\n  }\n\n  _setDisplayMode(displayMode) {\n    this._setProperty('displayMode', displayMode);\n    this._yearPanel.setDisplayMode(this.displayMode);\n    this._header.setDisplayMode(this.displayMode);\n  }\n\n  _setAvailableDisplayModes(availableDisplayModes) {\n    this._setProperty('availableDisplayModes', availableDisplayModes);\n    this._header.setAvailableDisplayModes(this.availableDisplayModes);\n  }\n\n  _setSelectionRange(selectionRange) {\n    selectionRange = DateRange.ensure(selectionRange);\n    this._setProperty('selectionRange', selectionRange);\n    this.session.onRequestsDone(this._updateMenuBar.bind(this));\n  }\n\n  _setSelectedResources(selectedResources) {\n    if (typeof selectedResources[0] === 'string') {\n      selectedResources = this._resourcesByIds(selectedResources);\n    }\n    if (this.rendered) {\n      this._removeSelectedResources();\n    }\n    this._setProperty('selectedResources', selectedResources);\n    this.session.onRequestsDone(this._updateMenuBar.bind(this));\n  }\n\n  _removeSelectedResources() {\n    this.selectedResources.forEach(function(resource) {\n      resource.$resource.select(false);\n    });\n  }\n\n  _renderSelectedResources() {\n    this.selectedResources.forEach(function(resource) {\n      resource.$resource.select(true);\n    });\n  }\n\n  _renderActivitySelectable() {\n    if (this.selectedActivity && this.selectedActivity.$activity) {\n      this.selectedActivity.$activity.toggleClass('selected', this.activitySelectable);\n    }\n  }\n\n  _renderSelectionMode() {\n    if (this.selectionMode === Planner.SelectionMode.NONE) {\n      if (this.$selector) {\n        this.$selector.remove();\n        this.$highlight.remove();\n      }\n    } else {\n      this._renderSelectionRange();\n    }\n  }\n\n  _renderSelectionRange() {\n    var $startRow, $lastRow,\n      from = this.selectionRange.from,\n      to = this.selectionRange.to,\n      startRow = this.selectedResources[0],\n      lastRow = this.selectedResources[this.selectedResources.length - 1];\n\n    // remove old selector\n    if (this.$selector) {\n      this.$selector.remove();\n      this.$highlight.remove();\n    }\n\n    if (!startRow || !lastRow || !this.selectionRange.from || !this.selectionRange.to) {\n      return;\n    }\n    $startRow = startRow.$resource;\n    $lastRow = lastRow.$resource;\n\n    // Make sure selection fits into scale\n    from = Math.max(from, this.beginScale);\n    to = Math.min(to, this.endScale);\n\n    // top and height\n    var $parent = ($startRow[0].offsetTop <= $lastRow[0].offsetTop) ? $startRow : $lastRow;\n    this.$selector = $parent.children('.resource-cells').appendDiv('selector');\n    this.$selector.cssHeight($startRow.outerHeight() + Math.abs($lastRow[0].offsetTop - $startRow[0].offsetTop));\n    var $selectorResizeLeft = this.$selector.appendDiv('selector-resize-left').mousedown(this._onResizeMouseDown.bind(this));\n    var $selectorResizeRight = this.$selector.appendDiv('selector-resize-right').mousedown(this._onResizeMouseDown.bind(this));\n    this.$selector\n      .css('left', 'calc(' + this.transformLeft(from) + '% - ' + $selectorResizeLeft.cssWidth() + 'px)')\n      .css('width', 'calc(' + this.transformWidth(from, to) + '% + ' + ($selectorResizeLeft.cssWidth() + $selectorResizeRight.cssWidth()) + 'px)')\n      .on('contextmenu', this._onRangeSelectorContextMenu.bind(this));\n\n    // colorize scale\n    this.$highlight = this.$timelineSmall.prependDiv('highlight');\n\n    var left = this.$selector.cssLeft() + $selectorResizeLeft.cssWidth() + this.$scaleTitle.cssWidth();\n    var width = this.$selector.cssWidth() - ($selectorResizeLeft.cssWidth() + $selectorResizeRight.cssWidth());\n    this.$highlight\n      .cssLeft(left)\n      .cssWidth(width);\n  }\n\n  _setSelectedActivity(selectedActivity) {\n    if (typeof selectedActivity === 'string') {\n      selectedActivity = this._activityById(selectedActivity);\n    }\n    if (this.rendered) {\n      this._removeSelectedActivity();\n    }\n    this._setProperty('selectedActivity', selectedActivity);\n    this.session.onRequestsDone(this._updateMenuBar.bind(this));\n  }\n\n  _removeSelectedActivity() {\n    if (this.selectedActivity && this.selectedActivity.$activity) {\n      this.selectedActivity.$activity.removeClass('selected');\n    }\n  }\n\n  _renderSelectedActivity() {\n    if (this.selectedActivity && this.selectedActivity.$activity) {\n      this.selectedActivity.$activity.addClass('selected');\n    }\n  }\n\n  _renderLabel() {\n    var label = this.label || '';\n    if (this.$scaleTitle) {\n      this.$scaleTitle.text(label);\n    }\n  }\n\n  _resourcesByIds(ids) {\n    return ids.map(this._resourceById.bind(this));\n  }\n\n  _activityById(id) {\n    return this.activityMap[id];\n  }\n\n  _resourceById(id) {\n    return this.resourceMap[id];\n  }\n\n  setDisplayMode(displayMode) {\n    this.setProperty('displayMode', displayMode);\n    this.startRange = null;\n    this.lastRange = null;\n  }\n\n  layoutYearPanel() {\n    if (this.yearPanelVisible) {\n      scrollbars.update(this._yearPanel.$yearList);\n      this._yearPanel._scrollYear();\n    }\n  }\n\n  setYearPanelVisible(visible) {\n    if (this.yearPanelVisible === visible) {\n      return;\n    }\n    this._setProperty('yearPanelVisible', visible);\n    if (this.rendered) {\n      this._renderYearPanelVisible(true);\n    }\n  }\n\n  setViewRangeFrom(date) {\n    var diff = this.viewRange.to.getTime() - this.viewRange.from.getTime(),\n      viewRange = new DateRange(this.viewRange.from, this.viewRange.to);\n\n    viewRange.from = date;\n    viewRange.to = new Date(date.getTime() + diff);\n    this.setViewRange(viewRange);\n  }\n\n  setViewRange(viewRange) {\n    if (this.viewRange === viewRange) {\n      return;\n    }\n    this._setViewRange(viewRange);\n\n    if (this.rendered) {\n      this._renderViewRange();\n      this._rerenderActivities();\n      this._renderSelectedActivity();\n      this.validateLayoutTree();\n    }\n  }\n\n  selectRange(range) {\n    if (range && range.equals(this.selectionRange)) {\n      return;\n    }\n    this.setProperty('selectionRange', range);\n  }\n\n  selectActivity(activity) {\n    this.setProperty('selectedActivity', activity);\n  }\n\n  selectResources(resources) {\n    if (arrays.equals(resources, this.selectedResources)) {\n      return;\n    }\n\n    resources = arrays.ensure(resources);\n    // Make a copy so that original array stays untouched\n    resources = resources.slice();\n    this.setProperty('selectedResources', resources);\n    this.trigger('resourcesSelected', {\n      resources: resources\n    });\n\n    if (this.rendered) {\n      // Render selection range as well for the case if selectedRange does not change but selected resources do\n      this._renderSelectionRange();\n    }\n  }\n\n  /**\n   * Returns true if a deselection happened. False if the given resources were not selected at all.\n   */\n  deselectResources(resources) {\n    var deselected = false;\n    resources = arrays.ensure(resources);\n    var selectedResources = this.selectedResources.slice(); // copy\n    if (arrays.removeAll(selectedResources, resources)) {\n      this.selectResources(selectedResources);\n      deselected = true;\n    }\n    return deselected;\n  }\n\n  insertResources(resources) {\n    // Update model\n    resources.forEach(function(resource) {\n      this._initResource(resource);\n      // Always insert new rows at the end, if the order is wrong a rowOrderChanged event will follow\n      this.resources.push(resource);\n    }.bind(this));\n\n    // Update HTML\n    if (this.rendered) {\n      this._renderResources(resources);\n      this.invalidateLayoutTree();\n    }\n  }\n\n  deleteResources(resources) {\n    if (this.deselectResources(resources)) {\n      this.selectRange(new DateRange());\n    }\n    resources.forEach(function(resource) {\n      // Update model\n      arrays.remove(this.resources, resource);\n      delete this.resourceMap[resource.id];\n\n      resource.activities.forEach(function(activity) {\n        delete this.activityMap[activity.id];\n      }.bind(this));\n\n      // Update HTML\n      if (this.rendered) {\n        resource.$resource.remove();\n        delete resource.$resource;\n      }\n    }.bind(this));\n\n    this.invalidateLayoutTree();\n  }\n\n  deleteAllResources() {\n    // Update HTML\n    if (this.rendered) {\n      this._removeAllResources();\n      this.invalidateLayoutTree();\n    }\n\n    // Update model\n    this.resources = [];\n    this.resourceMap = {};\n    this.activityMap = {};\n    this.selectResources([]);\n    this.selectRange(new DateRange());\n  }\n\n  updateResources(resources) {\n    resources.forEach(function(updatedResource) {\n      var oldResource = this.resourceMap[updatedResource.id];\n      if (!oldResource) {\n        throw new Error('Update event received for non existing resource. ResourceId: ' + updatedResource.id);\n      }\n\n      // Replace old resource\n      this._initResource(updatedResource);\n      arrays.replace(this.resources, oldResource, updatedResource);\n      arrays.replace(this.selectedResources, oldResource, updatedResource);\n\n      // Replace old $resource\n      if (this.rendered && oldResource.$resource) {\n        var $updatedResource = $(this._buildResourceHtml(updatedResource));\n        oldResource.$resource.replaceWith($updatedResource);\n        $updatedResource.css('min-width', oldResource.$resource.css('min-width'));\n        this._linkResource($updatedResource, updatedResource);\n        this._linkActivitiesForResource(updatedResource);\n      }\n    }.bind(this));\n  }\n}\n"]},"metadata":{},"sourceType":"module"}